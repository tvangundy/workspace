# https://taskfile.dev

version: '3'

tasks:
  overwrite:
    desc: Overwrite tasks/ and bin/ in dst-workspace with contents from src-workspace
    cmds:
      - |
        set -euo pipefail

        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -z "${CLI_ARGS_STR}" ]; then
          echo "Error: <src-workspace-path> and <dst-workspace-path> are required"
          echo "Usage: task workspace:overwrite -- <src-workspace-path> <dst-workspace-path>"
          echo "Example: task workspace:overwrite -- . ~/workspaces/my-workspace"
          echo "Example: task workspace:overwrite -- ~/forest-shadows ~/my-project"
          exit 1
        fi

        eval set -- ${CLI_ARGS_STR}
        SRC_PATH="${1:-}"
        DST_PATH="${2:-}"

        if [ -z "${SRC_PATH}" ] || [ -z "${DST_PATH}" ]; then
          echo "Error: <src-workspace-path> and <dst-workspace-path> are required"
          echo "Usage: task workspace:overwrite -- <src-workspace-path> <dst-workspace-path>"
          exit 1
        fi

        # Resolve . to absolute paths
        SRC_ABS=$(cd "${SRC_PATH}" && pwd)
        DST_ABS=$(cd "${DST_PATH}" && pwd)

        if [ ! -d "${SRC_ABS}/tasks" ] || [ ! -d "${SRC_ABS}/bin" ]; then
          echo "Error: src workspace must contain 'tasks' and 'bin' directories"
          echo "  Source: ${SRC_ABS}"
          exit 1
        fi

        if [ "${SRC_ABS}" = "${DST_ABS}" ]; then
          echo "Error: src and dst paths are the same (${SRC_ABS})"
          exit 1
        fi

        echo "Overwriting tasks/ and bin/ in ${DST_ABS} with contents from ${SRC_ABS}"
        rm -rf "${DST_ABS}/tasks" "${DST_ABS}/bin"
        cp -r "${SRC_ABS}/tasks" "${SRC_ABS}/bin" "${DST_ABS}/"
        echo "âœ… Done"
  instantiate:
    desc: Instantiate the workspace
    cmds:
      - | 
        set -euo pipefail

        # Parse CLI_ARGS - use eval to properly handle quoted arguments
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        
        # Both workspace-name and workspace-path are required
        if [ -z "${CLI_ARGS_STR}" ]; then
          echo "Error: <workspace-name> and <workspace-path> are required"
          echo "Usage: task workspace:instantiate -- <workspace-name> <workspace-path>"
          echo "Example: task workspace:instantiate -- my-workspace ~/workspaces/my-workspace"
          exit 1
        fi
        
        eval set -- ${CLI_ARGS_STR}
        WORKSPACE_NAME="${1:-}"
        WORKSPACE_PATH="${2:-}"
        
        if [ -z "${WORKSPACE_NAME}" ] || [ -z "${WORKSPACE_PATH}" ]; then
          echo "Error: <workspace-name> and <workspace-path> are required"
          echo "Usage: task workspace:instantiate -- <workspace-name> <workspace-path>"
          echo "Example: task workspace:instantiate -- my-workspace ~/workspaces/my-workspace"
          exit 1
        fi
        
        WORKSPACE_REPO_URL="https://github.com/tvangundy/workspace.git"

        echo "Initializing workspace..."
        echo "Workspace name: ${WORKSPACE_NAME}"
        echo "Workspace path: ${WORKSPACE_PATH}"
        echo ""

        mkdir -p "${WORKSPACE_PATH}"

        # If it's already a git repo, pull latest. Otherwise, clone into an empty directory.
        if [ -d "${WORKSPACE_PATH}/.git" ]; then
          echo "Existing git repository detected. Pulling latest changes..."
          git -C "${WORKSPACE_PATH}" pull --ff-only
        else
          if [ -n "$(ls -A "${WORKSPACE_PATH}" 2>/dev/null)" ]; then
            echo "Error: ${WORKSPACE_PATH} exists and is not empty, and is not a git repo."
            echo "Refusing to overwrite. Choose an empty directory or remove existing contents."
            exit 1
          fi

          echo "Cloning ${WORKSPACE_REPO_URL} into ${WORKSPACE_PATH}..."
          git clone "${WORKSPACE_REPO_URL}" "${WORKSPACE_PATH}"
        fi

        echo ""
        echo "Workspace initialized successfully."
    silent: true

  clean:
    desc: Clean up Docker images and containers
    cmds:
      - docker kill $(docker ps -q) && docker system prune -af

  #-----------------------------------------------------------------------------------------------------------------------
  # workspace
  #-----------------------------------------------------------------------------------------------------------------------

  help:
    desc: Workspace releated commands
    cmds:
      - |
        echo "Workspace"
        echo ""
        echo "    task workspace:instantiate -- <workspace-name> <workspace-path>"
        echo ""
        echo "    task workspace:overwrite -- <src-workspace-path> <dst-workspace-path>"
        echo ""
        echo "    task workspace:clean"
    silent: true
