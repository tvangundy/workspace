# https://taskfile.dev

version: '3'

tasks:
  web-ui:
    desc: Opens the Incus Web UI
    silent: true
    cmds:
      - |
        # Open Incus web UI in browser
        if [[ "$(uname)" == "Darwin" ]]; then
          open https://{{.INCUS_REMOTE_IP_0}}:8443/
        elif [[ "$(uname)" == "Linux" ]]; then
          xdg-open https://{{.INCUS_REMOTE_IP_0}}:8443/ 2>/dev/null || sensible-browser https://{{.INCUS_REMOTE_IP_0}}:8443/ 2>/dev/null || echo "Please open https://{{.INCUS_REMOTE_IP_0}}:8443/ in your browser"
        else
          echo "Please open https://{{.INCUS_REMOTE_IP_0}}:8443/ in your browser"
        fi

  create-instance:
    desc: Creates an Incus instance (defaults to UBUNTU_GITHUB_RUNNER_0_NAME if no name provided)
    silent: true
    cmds:
      - |
        set -euo pipefail
        
        # Get instance name from CLI args or use default
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -n "${CLI_ARGS_STR}" ]; then
          INSTANCE_NAME="${CLI_ARGS_STR}"
        else
          if [ -z "{{.UBUNTU_GITHUB_RUNNER_0_NAME}}" ]; then
            echo "Error: UBUNTU_GITHUB_RUNNER_0_NAME variable is not defined and no instance name provided"
            echo "Usage: task incus:create-instance [<instance-name>]"
            echo "Example: task incus:create-instance -- ubuntu-runner-0"
            exit 1
          fi
          INSTANCE_NAME="{{.UBUNTU_GITHUB_RUNNER_0_NAME}}"
        fi
        
        echo "Creating Incus instance: ${INSTANCE_NAME}"
        incus launch images:ubuntu/24.04 "${INSTANCE_NAME}"
        
  delete-instance:
    desc: Deletes an Incus instance (defaults to UBUNTU_GITHUB_RUNNER_0_NAME if no name provided)
    silent: true
    cmds:
      - |
        set -euo pipefail
        
        # Get instance name from CLI args or use default
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -n "${CLI_ARGS_STR}" ]; then
          INSTANCE_NAME="${CLI_ARGS_STR}"
        else
          if [ -z "{{.UBUNTU_GITHUB_RUNNER_0_NAME}}" ]; then
            echo "Error: UBUNTU_GITHUB_RUNNER_0_NAME variable is not defined and no instance name provided"
            echo "Usage: task incus:delete-instance [<instance-name>]"
            echo "Example: task incus:delete-instance -- ubuntu-runner-0"
            exit 1
          fi
          INSTANCE_NAME="{{.UBUNTU_GITHUB_RUNNER_0_NAME}}"
        fi
        
        echo "Deleting Incus instance: ${INSTANCE_NAME}"
        
        # Stop the instance first if it's running
        if incus list --format json | grep -q "\"name\":\"${INSTANCE_NAME}\""; then
          echo "Stopping instance..."
          incus stop "${INSTANCE_NAME}" 2>/dev/null || true
          echo "Deleting instance..."
          incus delete "${INSTANCE_NAME}"
          echo "Instance '${INSTANCE_NAME}' deleted successfully"
        else
          echo "Instance '${INSTANCE_NAME}' not found"
          exit 1
        fi

  download-talos-image:
    desc: Downloads the Talos cloud image for VMs
    silent: true
    cmds:
      - |
        set -euo pipefail
        
        # Validate required variables
        if [ -z "{{.WINDSOR_CONTEXT}}" ]; then
          echo "Error: WINDSOR_CONTEXT variable is not defined"
          echo "Set the context using: windsor context set <context>"
          exit 1
        fi
        
        if [ -z "{{.TALOS_IMAGE_VERSION}}" ]; then
          echo "Error: TALOS_IMAGE_VERSION variable is not defined"
          echo "Example: TALOS_IMAGE_VERSION=v1.11.6"
          exit 1
        fi
        
        if [ -z "{{.TALOS_IMAGE_ARCH}}" ]; then
          echo "Error: TALOS_IMAGE_ARCH variable is not defined"
          echo "Example: TALOS_IMAGE_ARCH=metal-amd64"
          exit 1
        fi
        
        if [ -z "{{.TALOS_IMAGE_SCHEMATIC_ID}}" ]; then
          echo "Error: TALOS_IMAGE_SCHEMATIC_ID variable is not defined"
          echo "Visit https://factory.talos.dev to create a schematic and get the schematic ID"
          echo "For a default image, you can use the empty/default schematic"
          exit 1
        fi
        
        DEVICES_DIR="contexts/{{.WINDSOR_CONTEXT}}/devices"
        TALOS_DIR="${DEVICES_DIR}/talos"
        # Use metal-amd64 for the Image Factory URL (standard format)
        IMAGE_ZST="${TALOS_DIR}/metal-amd64.raw.zst"
        IMAGE_RAW="${TALOS_DIR}/metal-amd64.raw"
        IMAGE_QCOW2="${TALOS_DIR}/talos-metal-amd64.qcow2"
        
        # Create devices directory structure
        mkdir -p "${TALOS_DIR}"
        
        # Check if final image already exists
        if [ -f "${IMAGE_QCOW2}" ]; then
          echo "Talos VM image already exists at ${IMAGE_QCOW2}"
          echo "Skipping download and conversion. Delete the file to re-download."
          exit 0
        fi
        
        # Download Talos raw disk image from Image Factory (compressed with zstd)
        # The Image Factory uses metal-amd64.raw.zst format
        IMAGE_URL="https://factory.talos.dev/image/{{.TALOS_IMAGE_SCHEMATIC_ID}}/{{.TALOS_IMAGE_VERSION}}/metal-amd64.raw.zst"
        
        echo "Downloading Talos raw disk image..."
        echo "URL: ${IMAGE_URL}"
        echo "Destination: ${IMAGE_ZST}"
        
        # Download if not already downloaded
        if [ ! -f "${IMAGE_ZST}" ]; then
          curl -L -o "${IMAGE_ZST}" "${IMAGE_URL}"
          
          if [ $? -ne 0 ]; then
            echo "Error: Failed to download Talos image"
            exit 1
          fi
          
          # Verify the download was successful (check file size is reasonable)
          FILE_SIZE=$(stat -f%z "${IMAGE_ZST}" 2>/dev/null || stat -c%s "${IMAGE_ZST}" 2>/dev/null || echo "0")
          if [ "${FILE_SIZE}" -lt 1000 ]; then
            echo "Error: Downloaded file is too small (${FILE_SIZE} bytes). The download may have failed."
            echo "Please check the URL and try again."
            rm -f "${IMAGE_ZST}"
            exit 1
          fi
        else
          echo "Compressed image already exists, skipping download"
        fi
        
        # Extract the compressed image using zstd
        if [ ! -f "${IMAGE_RAW}" ]; then
          echo "Extracting compressed image..."
          
          # Check if zstd is available
          if ! command -v zstd >/dev/null 2>&1; then
            echo "Error: zstd is not installed"
            echo "Install it with:"
            echo "  macOS: brew install zstd"
            echo "  Linux: apt-get install zstd (or equivalent)"
            exit 1
          fi
          
          zstd -d "${IMAGE_ZST}" -o "${IMAGE_RAW}"
          
          if [ $? -ne 0 ]; then
            echo "Error: Failed to extract Talos image"
            exit 1
          fi
        else
          echo "Raw image already exists, skipping extraction"
        fi
        
        # Convert raw image to QCOW2 format (required for Incus VMs)
        if [ ! -f "${IMAGE_QCOW2}" ]; then
          echo "Converting raw image to QCOW2 format..."
          
          # Check if qemu-img is available
          if ! command -v qemu-img >/dev/null 2>&1; then
            echo "Error: qemu-img is not installed"
            echo "Install it with:"
            echo "  macOS: brew install qemu"
            echo "  Linux: apt-get install qemu-utils (or equivalent)"
            exit 1
          fi
          
          qemu-img convert -f raw -O qcow2 "${IMAGE_RAW}" "${IMAGE_QCOW2}"
          
          if [ $? -ne 0 ]; then
            echo "Error: Failed to convert image to QCOW2"
            exit 1
          fi
          
          echo "Image converted successfully"
        else
          echo "QCOW2 image already exists, skipping conversion"
        fi
        
        echo ""
        echo "Talos VM image ready at: ${IMAGE_QCOW2}"
        echo "You can now launch VMs using this image"

  import-talos-image:
    desc: "Imports a Talos QCOW2 image into Incus with metadata (usage: task incus:import-talos-image [--alias <alias>])"
    silent: true
    cmds:
      - |
        set -euo pipefail
        
        # Validate required variables
        if [ -z "{{.WINDSOR_CONTEXT}}" ]; then
          echo "Error: WINDSOR_CONTEXT variable is not defined"
          echo "Set the context using: windsor context set <context>"
          exit 1
        fi
        
        if [ -z "{{.INCUS_REMOTE_NAME}}" ]; then
          echo "Error: INCUS_REMOTE_NAME variable is not defined"
          exit 1
        fi
        
        # Get image alias from CLI args or use default based on TALOS_IMAGE_VERSION
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -n "${CLI_ARGS_STR}" ]; then
          IMAGE_ALIAS="${CLI_ARGS_STR}"
        else
          if [ -z "{{.TALOS_IMAGE_VERSION}}" ]; then
            echo "Error: TALOS_IMAGE_VERSION variable is not defined and no alias provided"
            echo "Usage: task incus:import-talos-image [--alias <alias>]"
            echo "Example: task incus:import-talos-image -- talos-v1.12.0-metal-amd64"
            exit 1
          fi
          IMAGE_ALIAS="talos-{{.TALOS_IMAGE_VERSION}}-metal-amd64"
        fi
        
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        IMAGE_QCOW2="contexts/{{.WINDSOR_CONTEXT}}/devices/talos/talos-metal-amd64.qcow2"
        
        # Check if image exists
        if [ ! -f "${IMAGE_QCOW2}" ]; then
          echo "Error: Talos VM image not found at ${IMAGE_QCOW2}"
          echo "Run 'task incus:download-talos-image' first to download and prepare the image"
          exit 1
        fi
        
        # Check if image is already imported
        if incus image list "${REMOTE}:" --format json | grep -q "\"aliases\".*\"${IMAGE_ALIAS}\""; then
          echo "Image with alias '${IMAGE_ALIAS}' already exists on remote '${REMOTE}'"
          echo "Skipping import. Use a different alias or delete the existing image first."
          exit 0
        fi
        
        echo "Importing Talos VM image..."
        echo "Remote: ${REMOTE}"
        echo "Alias: ${IMAGE_ALIAS}"
        echo "Image: ${IMAGE_QCOW2}"
        
        # Create temporary directory for metadata
        TEMP_DIR=$(mktemp -d)
        trap "rm -rf ${TEMP_DIR}" EXIT
        
        METADATA_FILE="${TEMP_DIR}/metadata.yaml"
        METADATA_TAR="${TEMP_DIR}/metadata.tar.gz"
        
        # Create metadata.yaml for the image using printf to avoid heredoc issues
        CREATION_DATE=$(date +%s)
        printf "architecture: x86_64\n" > "${METADATA_FILE}"
        printf "creation_date: %s\n" "${CREATION_DATE}" >> "${METADATA_FILE}"
        printf "properties:\n" >> "${METADATA_FILE}"
        printf "  description: Talos Linux {{.TALOS_IMAGE_VERSION}} for VMs\n" >> "${METADATA_FILE}"
        printf "  os: Talos\n" >> "${METADATA_FILE}"
        printf "  release: {{.TALOS_IMAGE_VERSION}}\n" >> "${METADATA_FILE}"
        
        # Create metadata tarball
        tar -czf "${METADATA_TAR}" -C "${TEMP_DIR}" metadata.yaml
        
        # Import image with metadata (metadata tarball first, then disk image)
        incus image import "${METADATA_TAR}" "${IMAGE_QCOW2}" "${REMOTE}:" --alias "${IMAGE_ALIAS}"
        
        echo ""
        echo "Image imported successfully with alias: ${IMAGE_ALIAS}"

  create-physical-network:
    desc: Creates a physical network for direct attachment to the host network
    silent: true
    cmds:
      - |
        set -euo pipefail
        
        # Validate required variables
        if [ -z "{{.INCUS_REMOTE_NAME}}" ]; then
          echo "Error: INCUS_REMOTE_NAME variable is not defined"
          echo "Example: INCUS_REMOTE_NAME=nuc"
          exit 1
        fi
        
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        
        # Default physical interface name (most common on NUCs)
        # User can override by setting PHYSICAL_INTERFACE environment variable
        PHYSICAL_INTERFACE="${PHYSICAL_INTERFACE:-eno1}"
        
        echo "Creating physical network for direct attachment"
        echo "Remote: ${REMOTE}"
        echo "Physical interface: ${PHYSICAL_INTERFACE}"
        echo ""
        echo "Note: This assumes you've already added the 'instances' role to ${PHYSICAL_INTERFACE}"
        echo "      using 'incus admin os system network edit'"
        echo ""
        
        # Check if network already exists
        if incus network show "${REMOTE}:${PHYSICAL_INTERFACE}" >/dev/null 2>&1; then
          # Verify it's a physical network type
          NETWORK_JSON=$(incus network show "${REMOTE}:${PHYSICAL_INTERFACE}" --format json 2>/dev/null || echo "")
          
          if [ -n "${NETWORK_JSON}" ]; then
            NETWORK_TYPE=$(echo "${NETWORK_JSON}" | grep -o '"type":"[^"]*"' | cut -d'"' -f4 || echo "")
            
            if [ "${NETWORK_TYPE}" = "physical" ]; then
              echo "Physical network '${PHYSICAL_INTERFACE}' already exists on remote '${REMOTE}'"
              echo "Network type: ${NETWORK_TYPE} âœ“"
              echo "Skipping creation - network is already correctly configured."
              exit 0
            else
              echo "Warning: Network '${PHYSICAL_INTERFACE}' exists but is type '${NETWORK_TYPE}', not 'physical'"
              echo "You may need to delete it first: incus network delete ${REMOTE}:${PHYSICAL_INTERFACE}"
              echo "Then run this task again to create it as a physical network."
              exit 1
            fi
          else
            # Network show failed, but check returned success - network might not exist
            echo "Network '${PHYSICAL_INTERFACE}' check failed, proceeding with creation..."
          fi
        fi
        
        # Create the physical network
        echo "Creating physical network '${PHYSICAL_INTERFACE}'..."
        
        # Capture both stdout and stderr to see the actual error
        if ! incus network create "${REMOTE}:${PHYSICAL_INTERFACE}" parent="${PHYSICAL_INTERFACE}" --type=physical 2>&1; then
          echo ""
          echo "Error: Failed to create physical network"
          echo ""
          echo "Common causes:"
          echo "1. The 'instances' role has not been added to ${PHYSICAL_INTERFACE}"
          echo "   Run: incus admin os system network edit"
          echo "   Add 'instances' to the roles list for ${PHYSICAL_INTERFACE}"
          echo ""
          echo "2. The interface ${PHYSICAL_INTERFACE} doesn't exist or isn't available"
          echo "   Check available interfaces with: incus admin os system network show"
          echo ""
          echo "3. The interface name is incorrect"
          echo "   Set PHYSICAL_INTERFACE environment variable if your interface has a different name"
          exit 1
        fi
        
        echo ""
        echo "Physical network '${PHYSICAL_INTERFACE}' created successfully"
        echo "VMs attached to this network will get IP addresses directly from your physical network's DHCP server"

  launch-talos-vm:
    desc: Launches a Talos VM on IncusOS
    silent: true
    cmds:
      - |
        set -euo pipefail
        
        # Validate required variables
        if [ -z "{{.WINDSOR_CONTEXT}}" ]; then
          echo "Error: WINDSOR_CONTEXT variable is not defined"
          echo "Set the context using: windsor context set <context>"
          exit 1
        fi
        
        if [ -z "{{.INCUS_REMOTE_NAME}}" ]; then
          echo "Error: INCUS_REMOTE_NAME variable is not defined"
          echo "Example: INCUS_REMOTE_NAME=nuc"
          exit 1
        fi
        
        if [ -z "{{.TALOS_IMAGE_VERSION}}" ]; then
          echo "Error: TALOS_IMAGE_VERSION variable is not defined"
          echo "Example: TALOS_IMAGE_VERSION=v1.11.6"
          exit 1
        fi
        
        if [ -z "{{.TALOS_IMAGE_ARCH}}" ]; then
          echo "Error: TALOS_IMAGE_ARCH variable is not defined"
          echo "Example: TALOS_IMAGE_ARCH=amd64"
          exit 1
        fi
        
        # Parse CLI arguments: <vm-name> <vm-ip>
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -z "${CLI_ARGS_STR}" ]; then
          echo "Error: VM name and IP address required"
          echo "Usage: task incus:launch-talos-vm -- <vm-name> <vm-ip>"
          echo "Example: task incus:launch-talos-vm -- talos-cp 192.168.2.201"
          exit 1
        fi
        
        eval set -- ${CLI_ARGS_STR}
        VM_NAME="${1}"
        VM_IP="${2}"
        
        if [ -z "${VM_NAME}" ] || [ -z "${VM_IP}" ]; then
          echo "Error: Both VM name and IP address are required"
          echo "Usage: task incus:launch-talos-vm -- <vm-name> <vm-ip>"
          echo "Example: task incus:launch-talos-vm -- talos-cp 192.168.2.201"
          exit 1
        fi
        
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        IMAGE_QCOW2="contexts/{{.WINDSOR_CONTEXT}}/devices/talos/talos-metal-amd64.qcow2"
        
        # Check if image exists
        if [ ! -f "${IMAGE_QCOW2}" ]; then
          echo "Error: Talos VM image not found at ${IMAGE_QCOW2}"
          echo "Run 'task incus:download-talos-image' first to download and prepare the image"
          exit 1
        fi
        
        # Check if VM already exists
        if incus list "${REMOTE}:" --format json | grep -q "\"name\":\"${VM_NAME}\""; then
          echo "VM '${VM_NAME}' already exists on remote '${REMOTE}'"
          echo "Skipping creation. Use 'incus delete ${REMOTE}:${VM_NAME}' to remove it first."
          exit 0
        fi
        
        # Import the Talos image if not already imported
        IMAGE_ALIAS="talos-{{.TALOS_IMAGE_VERSION}}-metal-amd64"
        if ! incus image list "${REMOTE}:" --format json | grep -q "\"aliases\".*\"${IMAGE_ALIAS}\""; then
          echo "Importing Talos VM image..."
          
          # Create temporary directory for metadata
          TEMP_DIR=$(mktemp -d)
          METADATA_FILE="${TEMP_DIR}/metadata.yaml"
          METADATA_TAR="${TEMP_DIR}/metadata.tar.gz"
          
          # Create metadata.yaml for the image using printf to avoid heredoc issues
          CREATION_DATE=$(date +%s)
          printf "architecture: x86_64\n" > "${METADATA_FILE}"
          printf "creation_date: %s\n" "${CREATION_DATE}" >> "${METADATA_FILE}"
          printf "properties:\n" >> "${METADATA_FILE}"
          printf "  description: Talos Linux {{.TALOS_IMAGE_VERSION}} for VMs\n" >> "${METADATA_FILE}"
          printf "  os: Talos\n" >> "${METADATA_FILE}"
          printf "  release: {{.TALOS_IMAGE_VERSION}}\n" >> "${METADATA_FILE}"
          
          # Create metadata tarball
          tar -czf "${METADATA_TAR}" -C "${TEMP_DIR}" metadata.yaml
          
          # Import image with metadata (metadata tarball first, then disk image)
          incus image import "${METADATA_TAR}" "${IMAGE_QCOW2}" "${REMOTE}:" --alias "${IMAGE_ALIAS}"
          
          # Cleanup
          rm -rf "${TEMP_DIR}"
        fi
        
        # Use the physical network interface (default: eno1)
        # This should match the interface you configured in Step 4
        PHYSICAL_INTERFACE="${PHYSICAL_INTERFACE:-eno1}"
        
        echo "Launching Talos VM '${VM_NAME}' on remote '${REMOTE}'"
        echo "IP address: ${VM_IP}"
        echo "Image: ${IMAGE_ALIAS}"
        echo "Network: ${PHYSICAL_INTERFACE} (physical network)"
        
        # Launch the VM with the physical network
        # Disable Secure Boot for Talos Linux (it doesn't support Secure Boot)
        incus launch "${REMOTE}:${IMAGE_ALIAS}" "${REMOTE}:${VM_NAME}" \
          --vm \
          --network "${PHYSICAL_INTERFACE}" \
          --config limits.memory=2GB \
          --config limits.cpu=2 \
          --config boot.autostart=true \
          --config security.secureboot=false
        
        # Ensure the root disk is bootable with highest priority
        # Override the root device to set boot priority (since it comes from profile)
        incus config device override "${REMOTE}:${VM_NAME}" root boot.priority=1
        
        # Wait for VM to start
        echo "Waiting for VM to start..."
        sleep 5
        
        # The VM will get an IP address directly from your physical network's DHCP server
        # The IP address specified in VM_IP is informational - the actual IP will be assigned by DHCP
        
        echo "VM '${VM_NAME}' launched successfully"
        echo "VM IP should be: ${VM_IP}"
        echo "Note: The VM may take a few minutes to fully boot"

  start-daemon:
    desc: Start the Incus daemon
    silent: true
    cmds:
      - |
        set -euo pipefail
        
        # Check if running on macOS (likely using Colima)
        if [[ "$(uname)" == "Darwin" ]]; then
          # Check if Colima is running
          if ! colima status >/dev/null 2>&1; then
            echo "Starting Colima with Incus runtime..."
            colima start --runtime=incus
          else
            echo "Colima is already running"
            # Check if Incus is accessible
            if incus list local: >/dev/null 2>&1; then
              echo "Incus daemon is already accessible"
            else
              echo "Colima is running but Incus daemon may not be ready"
              echo "Wait a few seconds and try again"
            fi
          fi
        else
          # On Linux, try multiple methods
          DAEMON_STARTED=false
          
          # Method 1: Check if installed via snap
          if command -v snap >/dev/null 2>&1 && snap list incus >/dev/null 2>&1; then
            echo "Starting Incus daemon via snap..."
            sudo snap start incus.daemon || sudo snap start incus
            sleep 2
            if incus list >/dev/null 2>&1; then
              echo "Incus daemon started successfully (via snap)"
              DAEMON_STARTED=true
            fi
          fi
          
          # Method 2: Check if systemd service exists
          if [ "$DAEMON_STARTED" = false ] && command -v systemctl >/dev/null 2>&1; then
            if systemctl list-unit-files | grep -q incus.service; then
              echo "Starting Incus daemon using systemd..."
              sudo systemctl start incus
              sudo systemctl enable incus
              sleep 2
              if incus list >/dev/null 2>&1; then
                echo "Incus daemon started successfully (via systemd)"
                DAEMON_STARTED=true
              fi
            fi
          fi
          
          # Method 3: Try to start incusd directly
          if [ "$DAEMON_STARTED" = false ]; then
            if command -v incusd >/dev/null 2>&1; then
              echo "Starting Incus daemon directly (incusd)..."
              # Check if already running
              if pgrep -x incusd >/dev/null 2>&1; then
                echo "Incus daemon (incusd) is already running"
                DAEMON_STARTED=true
              else
                # Start in background
                sudo incusd --group incus --logfile /var/log/incus/incusd.log &
                sleep 3
                if incus list >/dev/null 2>&1; then
                  echo "Incus daemon started successfully (direct)"
                  DAEMON_STARTED=true
                fi
              fi
            fi
          fi
          
          # Method 4: Try incus daemon command
          if [ "$DAEMON_STARTED" = false ] && command -v incus >/dev/null 2>&1; then
            if incus list >/dev/null 2>&1; then
              echo "Incus daemon is already running"
              DAEMON_STARTED=true
            else
              echo "Attempting to start Incus daemon..."
              # Some installations use 'incus admin init' or have the daemon auto-start
              if incus admin init --auto >/dev/null 2>&1; then
                sleep 2
                if incus list >/dev/null 2>&1; then
                  echo "Incus daemon initialized and started"
                  DAEMON_STARTED=true
                fi
              fi
            fi
          fi
          
          # Final check
          if [ "$DAEMON_STARTED" = false ]; then
            echo ""
            echo "Warning: Could not start Incus daemon using standard methods"
            echo ""
            echo "Please try one of the following:"
            echo "1. If using snap: sudo snap start incus"
            echo "2. If systemd service exists: sudo systemctl start incus"
            echo "3. Start manually: sudo incusd &"
            echo "4. Check if Incus is installed: incus version"
            echo ""
            echo "If Incus is not installed, you may need to:"
            echo "- Install via snap: sudo snap install incus"
            echo "- Install via apt: sudo apt-get install incus"
            echo "- Or use Colima on macOS: colima start --runtime=incus"
            exit 1
          fi
        fi

  stop-daemon:
    desc: Stop the Incus daemon
    silent: true
    cmds:
      - |
        set -euo pipefail
        
        # Check if running on macOS (likely using Colima)
        if [[ "$(uname)" == "Darwin" ]]; then
          # Stop Colima (this stops the Incus daemon inside it)
          if colima status >/dev/null 2>&1; then
            echo "Stopping Colima (this will stop the Incus daemon)..."
            colima stop
          else
            echo "Colima is not running"
          fi
        else
          # On Linux, check if systemd is available
          if command -v systemctl >/dev/null 2>&1; then
            echo "Stopping Incus daemon using systemd..."
            sudo systemctl stop incus
          else
            # Try to find and kill incus process
            echo "Stopping Incus daemon..."
            INCUS_PID=$(pgrep -f "incus daemon" || echo "")
            if [ -n "${INCUS_PID}" ]; then
              sudo kill "${INCUS_PID}"
              echo "Incus daemon stopped"
            else
              echo "Incus daemon process not found (may already be stopped)"
            fi
          fi
        fi

  help:
    desc: Incus related commands
    cmds:
      - |
        echo "Incus"
        echo ""
        echo "Daemon Management:"
        echo "    task incus:start-daemon"
        echo "    task incus:stop-daemon"
        echo ""
        echo "Instance Management:"
        echo "    task incus:create-instance -- [<instance-name>]"
        echo "    task incus:delete-instance -- [<instance-name>]"
        echo "    (defaults to UBUNTU_GITHUB_RUNNER_0_NAME if no name provided)"
        echo ""
        echo "Other:"
        echo "    task incus:web-ui"
        echo ""
        echo "Talos VM Deployment:"
        echo "    task incus:download-talos-image"
        echo "    task incus:import-talos-image [--alias <alias>]"
        echo "    task incus:create-physical-network"
        echo "    task incus:launch-talos-vm -- <vm-name> <vm-ip>"
        echo ""
        echo "Also see [Incus docs](https://linuxcontainers.org/incus-os/docs/main/getting-started/)"
    silent: true
