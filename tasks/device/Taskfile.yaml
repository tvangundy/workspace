version: "3"

tasks:

  #-----------------------------------------------------------------------------------------------------------------------
  # Device
  #-----------------------------------------------------------------------------------------------------------------------

  download-image:
    desc: Downloads the Talos image
    cmds:
      - |
        set -euo pipefail
        
        # Validate required variables
        if [ -z "{{.WINDSOR_CONTEXT}}" ]; then
          echo "Error: WINDSOR_CONTEXT variable is not defined"
          echo "Set the context using: windsor context set <context>"
          exit 1
        fi
        
        if [ -z "{{.RPI_IMAGE_ARCH}}" ]; then
          echo "Error: RPI_IMAGE_ARCH variable is not defined"
          echo "RPI_IMAGE_ARCH should be set in the task variables (e.g., metal-arm64, metal-amd64)"
          exit 1
        fi
        
        if [ -z "{{.RPI_IMAGE_SCHEMATIC_ID}}" ]; then
          echo "Error: RPI_IMAGE_SCHEMATIC_ID variable is not defined"
          echo "RPI_IMAGE_SCHEMATIC_ID should be set in the task variables"
          exit 1
        fi
        
        if [ -z "{{.RPI_IMAGE_VERSION}}" ]; then
          echo "Error: RPI_IMAGE_VERSION variable is not defined"
          echo "RPI_IMAGE_VERSION should be set in the task variables (e.g., v1.11.5)"
          exit 1
        fi
      
        DEVICES_DIR="contexts/{{.WINDSOR_CONTEXT}}/devices"
        ARCH_DIR="${DEVICES_DIR}/{{.RPI_IMAGE_ARCH}}"
        IMAGE_FILE="${ARCH_DIR}/{{.RPI_IMAGE_ARCH}}.raw"
        IMAGE_XZ="${IMAGE_FILE}.xz"
        
        # Create devices directory structure
        mkdir -p "${ARCH_DIR}"
        
        # Download the image
        curl -L -o "${IMAGE_XZ}" https://factory.talos.dev/image/{{.RPI_IMAGE_SCHEMATIC_ID}}/{{.RPI_IMAGE_VERSION}}/{{.RPI_IMAGE_ARCH}}.raw.xz
        
        # Decompress the image
        xz -d "${IMAGE_XZ}"
        
        echo "Image downloaded to: ${IMAGE_FILE}"
      
  decompress-image:
    desc: Decompresses the Talos image
    cmds:
      - |
        echo ARGS: {{.CLI_ARGS}}
        # xz -d {{.CLI_ARGS}}
      
  list-disks:
    desc: Lists the sdcards
    cmds:
      - diskutil list
      # - sudo fdisk -l
      # udisksctl status
    silent: true

  
  write-disk:
    desc: Writes the Talos image to one or more USB drives
    cmds:
      - |
        set -euo pipefail
        
        # Validate required variables
        if [ -z "{{.WINDSOR_CONTEXT}}" ]; then
          echo "Error: WINDSOR_CONTEXT variable is not defined"
          echo "Set the context using: windsor context set <context>"
          exit 1
        fi
        
        if [ -z "{{.RPI_IMAGE_ARCH}}" ]; then
          echo "Error: RPI_IMAGE_ARCH variable is not defined"
          echo "RPI_IMAGE_ARCH should be set in the task variables (e.g., metal-arm64, metal-amd64)"
          exit 1
        fi
        
        if [ -z "{{.USB_DISK}}" ]; then
          echo "Error: USB_DISK variable is not defined"
          echo "USB_DISK should specify the first disk device (e.g., /dev/disk4)"
          echo "Use 'task device:list-disks' to see available disks"
          exit 1
        fi
        
        # Parse disk_count from CLI_ARGS (optional, defaults to 1 for single disk)
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -n "${CLI_ARGS_STR}" ]; then
          eval set -- ${CLI_ARGS_STR}
          DISK_COUNT="${1:-1}"
          
          if ! [[ "${DISK_COUNT}" =~ ^[0-9]+$ ]] || [ "${DISK_COUNT}" -lt 1 ]; then
            echo "Error: disk_count must be a positive integer (minimum 1)"
            echo "Usage: task device:write-disk [-- <disk_count>]"
            echo "Example: task device:write-disk -- 2"
            exit 1
          fi
          # When argument provided, disk_count represents total number of disks
          TOTAL_DISKS=${DISK_COUNT}
        else
          # No arguments provided, default to 1 disk (write only to base disk)
          TOTAL_DISKS=1
        fi
        
        # Extract disk number from USB_DISK (e.g., "4" from "/dev/disk4")
        BASE_DISK="{{.USB_DISK}}"
        if [[ ! "${BASE_DISK}" =~ ^/dev/disk[0-9]+$ ]]; then
          echo "Error: USB_DISK must be in format /dev/disk<N> (e.g., /dev/disk4)"
          echo "Current value: ${BASE_DISK}"
          exit 1
        fi
        
        # Extract disk number using parameter expansion (more reliable than BASH_REMATCH)
        BASE_DISK_NUM="${BASE_DISK#/dev/disk}"
        if [ -z "${BASE_DISK_NUM}" ] || ! [[ "${BASE_DISK_NUM}" =~ ^[0-9]+$ ]]; then
          echo "Error: Failed to extract valid disk number from USB_DISK: ${BASE_DISK}"
          exit 1
        fi
        DISK_PREFIX="/dev/disk"
        
        RAW_FILE="contexts/{{.WINDSOR_CONTEXT}}/devices/{{.RPI_IMAGE_ARCH}}/{{.RPI_IMAGE_ARCH}}.raw"
        if [ ! -f "${RAW_FILE}" ]; then
          echo "Error: Image file not found at ${RAW_FILE}"
          echo "Run 'task device:download-image' first to download the image"
          exit 1
        fi
        
        echo "Writing image to ${TOTAL_DISKS} disk(s) starting from ${BASE_DISK}..."
        echo ""
        
        # Write to each disk
        for ((i=0; i<TOTAL_DISKS; i++)); do
          CURRENT_DISK_NUM=$((BASE_DISK_NUM + i))
          CURRENT_DISK="${DISK_PREFIX}${CURRENT_DISK_NUM}"
          
          echo "Writing to ${CURRENT_DISK} ($((i+1))/${TOTAL_DISKS})..."
          sudo dd if="${RAW_FILE}" of="${CURRENT_DISK}" conv=fsync
          
          if [ $? -eq 0 ]; then
            echo "Successfully wrote image to ${CURRENT_DISK}"
          else
            echo "Error: Failed to write image to ${CURRENT_DISK}"
            exit 1
          fi
          echo ""
        done
        
        echo "Successfully wrote image to all ${TOTAL_DISKS} disk(s)"
    silent: true
    
  unmount-disk:
    desc: Unmounts one or more USB disks
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.USB_DISK}}" ]; then
          echo "Error: USB_DISK variable is not defined"
          echo "USB_DISK should specify the first disk device (e.g., /dev/disk4)"
          echo "Use 'task device:list-disks' to see available disks"
          exit 1
        fi
        
        # Parse disk_count from CLI_ARGS (optional, defaults to 1 for single disk)
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -n "${CLI_ARGS_STR}" ]; then
          eval set -- ${CLI_ARGS_STR}
          DISK_COUNT="${1:-1}"
          
          if ! [[ "${DISK_COUNT}" =~ ^[0-9]+$ ]] || [ "${DISK_COUNT}" -lt 1 ]; then
            echo "Error: disk_count must be a positive integer (minimum 1)"
            echo "Usage: task device:unmount-disk [-- <disk_count>]"
            exit 1
          fi
          # When argument provided, disk_count represents total number of disks
          TOTAL_DISKS=${DISK_COUNT}
        else
          # No arguments provided, default to 1 disk (unmount only base disk)
          TOTAL_DISKS=1
        fi
        
        # Extract disk number from USB_DISK (e.g., "4" from "/dev/disk4")
        BASE_DISK="{{.USB_DISK}}"
        if [[ ! "${BASE_DISK}" =~ ^/dev/disk[0-9]+$ ]]; then
          echo "Error: USB_DISK must be in format /dev/disk<N> (e.g., /dev/disk4)"
          echo "Current value: ${BASE_DISK}"
          exit 1
        fi
        
        # Extract disk number using parameter expansion (more reliable than BASH_REMATCH)
        BASE_DISK_NUM="${BASE_DISK#/dev/disk}"
        if [ -z "${BASE_DISK_NUM}" ] || ! [[ "${BASE_DISK_NUM}" =~ ^[0-9]+$ ]]; then
          echo "Error: Failed to extract valid disk number from USB_DISK: ${BASE_DISK}"
          exit 1
        fi
        DISK_PREFIX="/dev/disk"
        
        
        echo "Unmounting ${TOTAL_DISKS} disk(s) starting from ${BASE_DISK}..."
        echo ""
        
        # Unmount each disk
        for ((i=0; i<TOTAL_DISKS; i++)); do
          CURRENT_DISK_NUM=$((BASE_DISK_NUM + i))
          CURRENT_DISK="${DISK_PREFIX}${CURRENT_DISK_NUM}"
          
          echo "Unmounting ${CURRENT_DISK} ($((i+1))/${TOTAL_DISKS})..."
          diskutil unmountDisk "${CURRENT_DISK}" || {
            echo "Warning: Failed to unmount ${CURRENT_DISK} (may already be unmounted)"
          }
          echo ""
        done
        
        echo "Unmounting completed for ${TOTAL_DISKS} disk(s)"
        # if on rpi, stop the automount service
        # sudo systemctl stop udisks2 
        # sudo umount /dev/sdb
    silent: true
    
  eject-disk:
    desc: Ejects one or more USB disks
    depends:
      - unmount-disk
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.USB_DISK}}" ]; then
          echo "Error: USB_DISK variable is not defined"
          echo "USB_DISK should specify the first disk device (e.g., /dev/disk4)"
          echo "Use 'task device:list-disks' to see available disks"
          exit 1
        fi
        
        # Parse disk_count from CLI_ARGS (optional, defaults to 1 for single disk)
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -n "${CLI_ARGS_STR}" ]; then
          eval set -- ${CLI_ARGS_STR}
          DISK_COUNT="${1:-1}"
          
          if ! [[ "${DISK_COUNT}" =~ ^[0-9]+$ ]] || [ "${DISK_COUNT}" -lt 1 ]; then
            echo "Error: disk_count must be a positive integer (minimum 1)"
            echo "Usage: task device:eject-disk [-- <disk_count>]"
            exit 1
          fi
          # When argument provided, disk_count represents total number of disks
          TOTAL_DISKS=${DISK_COUNT}
        else
          # No arguments provided, default to 1 disk (eject only base disk)
          TOTAL_DISKS=1
        fi
        
        # Extract disk number from USB_DISK (e.g., "4" from "/dev/disk4")
        BASE_DISK="{{.USB_DISK}}"
        if [[ ! "${BASE_DISK}" =~ ^/dev/disk[0-9]+$ ]]; then
          echo "Error: USB_DISK must be in format /dev/disk<N> (e.g., /dev/disk4)"
          echo "Current value: ${BASE_DISK}"
          exit 1
        fi
        
        # Extract disk number using parameter expansion (more reliable than BASH_REMATCH)
        BASE_DISK_NUM="${BASE_DISK#/dev/disk}"
        if [ -z "${BASE_DISK_NUM}" ] || ! [[ "${BASE_DISK_NUM}" =~ ^[0-9]+$ ]]; then
          echo "Error: Failed to extract valid disk number from USB_DISK: ${BASE_DISK}"
          exit 1
        fi
        DISK_PREFIX="/dev/disk"
        
        
        echo "Ejecting ${TOTAL_DISKS} disk(s) starting from ${BASE_DISK}..."
        echo ""
        
        # Eject each disk
        for ((i=0; i<TOTAL_DISKS; i++)); do
          CURRENT_DISK_NUM=$((BASE_DISK_NUM + i))
          CURRENT_DISK="${DISK_PREFIX}${CURRENT_DISK_NUM}"
          
          echo "Ejecting ${CURRENT_DISK} ($((i+1))/${TOTAL_DISKS})..."
          diskutil eject "${CURRENT_DISK}" || {
            echo "Warning: Failed to eject ${CURRENT_DISK}"
          }
          echo ""
        done
        
        echo "Ejection completed for ${TOTAL_DISKS} disk(s)"
        # sudo eject /dev/sdb
    silent: true

  apply-talos-cluster:
    desc: Applies the Talos cluster configuration
    cmds:
      - |
        set -euo pipefail
        
        # Validate required variables
        if [ -z "{{.WINDSOR_CONTEXT}}" ]; then
          echo "Error: WINDSOR_CONTEXT variable is not defined"
          echo "Set the context using: windsor context set <context>"
          exit 1
        fi
        
        # Parse IP addresses from CLI_ARGS
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -z "${CLI_ARGS_STR}" ]; then
          echo "Error: At least one IP address is required"
          echo "Usage: task device:apply-talos-cluster -- <ip1> [<ip2> ... <ipN>]"
          echo "Example: task device:apply-talos-cluster -- 192.168.2.111 192.168.2.125"
          exit 1
        fi
        
        # Build nodes argument from CLI_ARGS
        eval set -- ${CLI_ARGS_STR}
        NODES_ARG=""
        for ip in "$@"; do
          # Basic IP validation
          if [[ ! "${ip}" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
            echo "Error: Invalid IP address format: ${ip}"
            exit 1
          fi
          NODES_ARG="${NODES_ARG} ${ip}"
        done
        
        # Remove leading space
        NODES_ARG="${NODES_ARG# }"
        
        echo "Applying Talos configuration to nodes: ${NODES_ARG}"
        talosctl apply-config --insecure --mode=interactive --nodes ${NODES_ARG} --talosconfig contexts/{{.WINDSOR_CONTEXT}}/.talos/talosconfig.yaml
    silent: true

  talos-dashboard:
    desc: Runs the Talos dashboard
    cmds:
      - |
        talosctl dashboard --nodes {{.CLI_ARGS}} 
    silent: true

  retrieve-kubeconfig:
    desc: Retrieves the kubeconfig
    cmds:
      - |
        talosctl kubeconfig --nodes {{.CLI_ARGS}}
    silent: true

  format-xfs:
    desc: Formats the USB disk (Requires Linux)
    cmds:
      - echo "Unmount the USB drives in ubuntu"
      - sudo mkfs.xfs /dev/sda
      - sudo mkfs.ext4 /dev/sda
      - sudo apt-get install xfsprogs
    silent: true

  get-disks:
    desc: Gets the disks
    cmds:
      - |
        talosctl get disks --insecure --nodes {{.CLI_ARGS}}
    silent: true

  generate-talosconfig:
    desc: Generates the Talos configuration
    cmds:
      - |
        talosctl gen config {{.CLUSTER_NAME}} https://{{.CONTROL_PLANE_IP}}:6443 --install-disk {{.CLI_ARGS}} --config contexts/{{.WINDSOR_CONTEXT}}/.talos/talosconfig.yaml
    silent: true

  apply-configuration:
    desc: Applies the Talos configuration
    cmds:
      - |
        set -euo pipefail
        
        # Parse IP addresses from CLI_ARGS
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -z "${CLI_ARGS_STR}" ]; then
          echo "Error: At least one IP address is required (control-plane-ip)"
          echo "Usage: task device:apply-configuration -- <control-plane-ip> [<worker-ip1> <worker-ip2> ...]"
          echo "Example: task device:apply-configuration -- 192.168.2.31 192.168.2.111 192.168.2.125"
          exit 1
        fi
        
        # Parse arguments: first is control plane, rest are workers
        eval set -- ${CLI_ARGS_STR}
        CONTROL_PLANE_IP="${1}"
        
        # Validate control plane IP format
        if [[ ! "${CONTROL_PLANE_IP}" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
          echo "Error: Invalid control plane IP address format: ${CONTROL_PLANE_IP}"
          exit 1
        fi
        
        # Apply configuration to control plane
        echo "Applying control plane configuration to: ${CONTROL_PLANE_IP}"
        talosctl apply-config --insecure --nodes "${CONTROL_PLANE_IP}" --file controlplane.yaml
        
        # Apply configuration to worker nodes (if any)
        shift  # Remove control plane IP from arguments
        if [ $# -gt 0 ]; then
          echo ""
          echo "Applying worker configurations..."
          for ip in "$@"; do
            # Validate worker IP format
            if [[ ! "${ip}" =~ ^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$ ]]; then
              echo "Error: Invalid worker IP address format: ${ip}"
              exit 1
            fi
            echo "Applying config to worker node: ${ip}"
            talosctl apply-config --insecure --nodes "${ip}" --file worker.yaml
          done
        else
          echo "No worker nodes specified"
        fi
        
        echo ""
        echo "Configuration applied successfully"
    silent: true

  help:
    desc: Device releated commands
    cmds:
      - |
        echo "Device"
        echo ""
        echo "    task device:download-image"
        echo "    task device:list-disks"
        echo "    task device:write-disk [-- <disk_count>]"
        echo "    task device:unmount-disk [-- <disk_count>]"
        echo "    task device:eject-disk [-- <disk_count>]"
        echo "    task device:apply-talos-cluster -- <control-plane-ip>"
        echo "    task device:get-disks -- <control-plane-ip>"
        echo "    task device:generate-talosconfig -- <control-plane-ip>"
        echo "    task device:apply-configuration -- <control-plane-ip> <worker-ip1> <worker-ip2> ..."

        # echo "    task device:talos-dashboard -- <control-plane-ip> <worker-ip1> <worker-ip2> ..."
        # echo "    task device:retrieve-kubeconfig -- <control-plane-ip> <worker-ip1> <worker-ip2> ..."
    silent: true
