# https://taskfile.dev
# Device preparation tasks - uses scripts from bin/device/

version: "3"

tasks:

  #-----------------------------------------------------------------------------------------------------------------------
  # Download images
  #-----------------------------------------------------------------------------------------------------------------------

  download-talos-image:
    desc: Downloads the Talos image
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/download-talos-image.sh"

  prepare-incus-image:
    desc: Copies IncusOS image from Downloads to the devices folder
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/prepare-incus-image.sh"

  download-ubuntu-img:
    desc: Downloads or moves Ubuntu image to the devices folder
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/download-ubuntu-img.sh"

  #-----------------------------------------------------------------------------------------------------------------------
  # BIOS update (Intel NUC)
  #-----------------------------------------------------------------------------------------------------------------------

  prepare-bios:
    desc: Copies BIOS update files to the devices folder
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/prepare-bios.sh"

  write-bios-disk:
    desc: Formats USB as FAT32 and copies BIOS update files (for Intel NUC BIOS updates)
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/write-bios-disk.sh"

  #-----------------------------------------------------------------------------------------------------------------------
  # Disks
  #-----------------------------------------------------------------------------------------------------------------------

  list-disks:
    desc: Lists the available disks
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/list-disks.sh"
    silent: true

  write-talos-disk:
    desc: Writes the Talos image to one or more USB drives
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/write-talos-disk.sh" "{{.CLI_ARGS}}"
    silent: true

  write-ubuntu-img:
    desc: Writes the Ubuntu image to one or more USB drives
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/write-ubuntu-img.sh" "{{.CLI_ARGS}}"

  write-incus-disk:
    desc: Writes the IncusOS image to one or more USB drives
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/write-incus-disk.sh" "{{.CLI_ARGS}}"

  unmount-disk:
    desc: Unmounts one or more USB disks
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/unmount-disk.sh" "{{.CLI_ARGS}}"
    silent: true

  eject-disk:
    desc: Ejects one or more USB disks (unmounts first)
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/eject-disk.sh" "{{.CLI_ARGS}}"
    silent: true

  #-----------------------------------------------------------------------------------------------------------------------
  # Talos cluster
  #-----------------------------------------------------------------------------------------------------------------------

  get-disks:
    desc: Gets the disks from a Talos node
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/get-disks.sh" {{.CLI_ARGS}}
    silent: true

  generate-talosconfig:
    desc: Generates the Talos configuration
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/generate-talosconfig.sh" {{.CLI_ARGS}}
    silent: true

  apply-configuration:
    desc: Applies the Talos configuration
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/apply-configuration.sh" "{{.CLI_ARGS}}"
    silent: true

  set-endpoints:
    desc: Sets the Talos API endpoints
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/set-endpoints.sh" {{.CLI_ARGS}}
    silent: true

  bootstrap-etc-cluster:
    desc: Bootstraps the etcd cluster
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/bootstrap-etc-cluster.sh" {{.CLI_ARGS}}
    silent: true

  retrieve-kubeconfig:
    desc: Retrieves the kubeconfig
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/retrieve-kubeconfig.sh" {{.CLI_ARGS}}
    silent: true

  #-----------------------------------------------------------------------------------------------------------------------
  # Cluster management
  #-----------------------------------------------------------------------------------------------------------------------

  cluster-health:
    desc: Checks the cluster health
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/cluster-health.sh" {{.CLI_ARGS}}
    silent: true

  talos-dashboard:
    desc: Runs the Talos dashboard
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/device/scripts"
        "${SCRIPT_DIR}/talos-dashboard.sh" {{.CLI_ARGS}}
    silent: true

  help:
    desc: Device-related commands
    cmds:
      - |
        echo "Device"
        echo ""
        echo "Download images:"
        echo "    task device:download-talos-image"
        echo "    task device:prepare-incus-image"
        echo "    task device:download-ubuntu-img"
        echo ""
        echo "BIOS update (Intel NUC):"
        echo "    task device:prepare-bios"
        echo "    task device:write-bios-disk"
        echo ""
        echo "Disks:"
        echo "    task device:list-disks"
        echo "    task device:write-talos-disk [-- <disk_count>]"
        echo "    task device:write-ubuntu-img [-- <disk_count>]"
        echo "    task device:write-incus-disk [-- <disk_count>]"
        echo "    task device:unmount-disk [-- <disk_count>]"
        echo "    task device:eject-disk [-- <disk_count>]"
        echo ""
        echo "Talos cluster:"
        echo "    task device:get-disks -- <control-plane-ip>"
        echo "    task device:generate-talosconfig -- <install-disk>"
        echo "    task device:apply-configuration -- <control-plane-ip> [<worker-ip1> <worker-ip2> ...]"
        echo "    task device:set-endpoints -- <control-plane-ip>"
        echo "    task device:bootstrap-etc-cluster -- <control-plane-ip>"
        echo "    task device:retrieve-kubeconfig -- <control-plane-ip>"
        echo ""
        echo "Cluster management:"
        echo "    task device:cluster-health -- <control-plane-ip>"
        echo "    task device:talos-dashboard -- <control-plane-ip>"
    silent: true
