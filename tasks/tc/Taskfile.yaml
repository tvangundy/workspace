# https://taskfile.dev
# Talos cluster on Incus. Single entrypoint: instantiate (like vm:instantiate).

version: '3'

tasks:

  instantiate:
    silent: true
    desc: "Create and bootstrap a Talos cluster on Incus. Usage: task tc:instantiate -- <remote-name> <remote-ip> [<cluster-name>] [--destroy]"
    cmds:
      - task: instantiate:parse-args
      - task: instantiate:initialize-context
      - task: instantiate:verify-remote
      - task: instantiate:check-existing-vms
      - task: instantiate:check-talos-image
      - task: instantiate:create-cluster-vms
      - task: instantiate:wait-for-vms
      - task: instantiate:get-ip-addresses
      - task: instantiate:regenerate-tfvars-with-ips
      - task: instantiate:retrieve-kubeconfig
      - task: instantiate:final-summary
      - task: instantiate:cleanup-if-needed

  instantiate:parse-args:
    silent: true
    desc: "Parse CLI arguments for instantiate"
    cmds:
      - |
        set -euo pipefail
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        source "${SCRIPT_DIR}/parse-args.sh" "{{.CLI_ARGS}}"

  instantiate:initialize-context:
    silent: true
    desc: "Initialize Windsor context and create windsor.yaml"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/initialize-context.sh"

  instantiate:verify-remote:
    silent: true
    desc: "Verify Incus remote exists and is reachable"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/verify-remote.sh"

  instantiate:check-existing-vms:
    silent: true
    desc: "Fail if cluster VMs already exist"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/check-existing-vms.sh"

  instantiate:check-talos-image:
    silent: true
    desc: "Ensure Talos image is available (warn only)"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/check-talos-image.sh"

  instantiate:create-cluster-vms:
    silent: true
    desc: "Create cluster VMs via Terraform"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/create-cluster-vms.sh"

  instantiate:wait-for-vms:
    silent: true
    desc: "Wait for all VMs to be running"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/wait-for-vms.sh"

  instantiate:get-ip-addresses:
    silent: true
    desc: "Get IPs from Terraform, update windsor.yaml"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/get-ip-addresses.sh"

  instantiate:regenerate-tfvars-with-ips:
    silent: true
    desc: "Regenerate tfvars with IPs and apply Talos config"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/regenerate-tfvars-with-ips.sh"

  instantiate:retrieve-kubeconfig:
    silent: true
    desc: "Retrieve kubeconfig from cluster"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/retrieve-kubeconfig.sh"

  instantiate:final-summary:
    silent: true
    desc: "Print success summary"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/final-summary.sh"

  instantiate:cleanup-if-needed:
    silent: true
    desc: "Destroy cluster if --destroy was set"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/cleanup-if-needed.sh"

  destroy:
    silent: true
    desc: "Destroy the Talos cluster. Usage: task tc:destroy [-- <cluster-name>]"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/destroy.sh" "{{.CLI_ARGS}}"

  delete:
    silent: true
    desc: "Delete the Talos cluster VMs directly using Incus (bypasses Terraform). Optionally specify cluster name: task tc:delete [-- <cluster-name>]"
    cmds:
      - |
        set -euo pipefail
        
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        
        if [ -z "${REMOTE}" ]; then
          echo "Error: INCUS_REMOTE_NAME variable is not defined"
          exit 1
        fi
        
        # Parse cluster name from CLI args or use default
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -n "${CLI_ARGS_STR}" ]; then
          eval set -- ${CLI_ARGS_STR}
          CLUSTER_NAME_ARG="${1}"
        else
          # Use default from environment variables
          if [ -n "{{.CLUSTER_NAME}}" ]; then
            CLUSTER_NAME_ARG="{{.CLUSTER_NAME}}"
          else
            CLUSTER_NAME_ARG="talos-test-cluster"
          fi
        fi
        
        # Define cluster VM names
        CONTROL_PLANE_VM="${CLUSTER_NAME_ARG}-cp"
        WORKER_0_VM="${CLUSTER_NAME_ARG}-worker-0"
        WORKER_1_VM="${CLUSTER_NAME_ARG}-worker-1"
        
        echo "Deleting Talos cluster '${CLUSTER_NAME_ARG}' VMs directly via Incus..."
        echo "  Control plane: ${CONTROL_PLANE_VM}"
        echo "  Worker 0:      ${WORKER_0_VM}"
        echo "  Worker 1:      ${WORKER_1_VM}"
        echo ""
        
        # Check which VMs exist
        VMS_TO_DELETE=()
        for VM in "${CONTROL_PLANE_VM}" "${WORKER_0_VM}" "${WORKER_1_VM}"; do
          if incus list "${REMOTE}:${VM}" --format csv -c n 2>/dev/null | grep -q "^${VM}$"; then
            VMS_TO_DELETE+=("${VM}")
          fi
        done
        
        if [ ${#VMS_TO_DELETE[@]} -eq 0 ]; then
          echo "⚠️  No cluster VMs found for cluster '${CLUSTER_NAME_ARG}' on remote '${REMOTE}'"
          echo "   (Cluster may have already been deleted)"
          exit 0
        fi
        
        # Show VM status before deletion
        echo "Cluster VMs to be deleted:"
        for VM in "${VMS_TO_DELETE[@]}"; do
          echo ""
          echo "  ${VM}:"
          incus list "${REMOTE}:${VM}" || true
        done
        echo ""
        
        # Confirm deletion
        echo "⚠️  This will permanently delete ${#VMS_TO_DELETE[@]} VM(s) and all their data"
        echo "   This action cannot be undone and will NOT update Terraform state"
        echo "   Press Ctrl+C to cancel, or wait 5 seconds to continue..."
        sleep 5
        echo ""
        
        # Delete VMs via Incus
        DELETED_COUNT=0
        FAILED_COUNT=0
        
        for VM in "${VMS_TO_DELETE[@]}"; do
          echo "Deleting ${VM}..."
          set +e  # Temporarily disable exit on error
          INCUS_DELETE_OUTPUT=$(incus delete "${REMOTE}:${VM}" --force 2>&1)
          INCUS_DELETE_EXIT=$?
          set -e  # Re-enable exit on error
          
          if [ ${INCUS_DELETE_EXIT} -eq 0 ]; then
            echo "  ✅ ${VM} deleted successfully"
            DELETED_COUNT=$((DELETED_COUNT + 1))
          else
            echo "  ❌ Failed to delete ${VM}"
            if [ -n "${INCUS_DELETE_OUTPUT}" ]; then
              echo "     Error: ${INCUS_DELETE_OUTPUT}"
            fi
            FAILED_COUNT=$((FAILED_COUNT + 1))
          fi
        done
        
        echo ""
        if [ ${FAILED_COUNT} -eq 0 ]; then
          echo "✅ Successfully deleted ${DELETED_COUNT} VM(s) for cluster '${CLUSTER_NAME_ARG}'"
        else
          echo "⚠️  Deleted ${DELETED_COUNT} VM(s), but ${FAILED_COUNT} VM(s) failed to delete"
          echo "   You may need to manually delete the remaining VMs or run 'task tc:destroy'"
          exit 1
        fi

  list:
    silent: true
    desc: "List all Talos clusters"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/tc/scripts"
        "${SCRIPT_DIR}/list.sh"

  help:
    silent: true
    desc: "Talos cluster commands"
    cmds:
      - |
        echo "Talos Cluster (Incus)"
        echo ""
        echo "Create cluster:"
        echo "    task tc:instantiate -- <remote-name> <remote-ip> [<cluster-name>] [--destroy]"
        echo "      Creates and bootstraps a Talos cluster."
        echo "      Arguments:"
        echo "        <remote-name>          Required: Name of the Incus remote"
        echo "        <remote-ip>            Required: IP address of the Incus remote"
        echo "        <cluster-name>         Optional: Name for the cluster (default: 'talos-test-cluster')"
        echo "      Options:"
        echo "        --destroy               Destroy cluster at end (default: keep cluster running)"
        echo ""
        echo "Examples:"
        echo "    task tc:instantiate -- nuc 192.168.2.101"
        echo "    task tc:instantiate -- nuc 192.168.2.101 my-cluster"
        echo "    task tc:instantiate -- nuc 192.168.2.101 my-cluster --destroy"
        echo ""
        echo "List clusters:"
        echo "    task tc:list"
        echo "      Lists all Talos clusters and their status."
        echo ""
        echo "Destroy cluster:"
        echo "    task tc:destroy [-- <cluster-name>]"
        echo "      Destroys the Talos cluster using Terraform and cleans up config files."
        echo "      If <cluster-name> is not provided, uses the current context."
        echo ""
        echo "Delete cluster (direct Incus):"
        echo "    task tc:delete [-- <cluster-name>]"
        echo "      Deletes cluster VMs directly via Incus (bypasses Terraform)."
        echo "      Does NOT update Terraform state. Use for quick cleanup."
        echo "      If <cluster-name> is not provided, uses the current context."
        echo ""
