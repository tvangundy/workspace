# https://taskfile.dev
# GitHub Actions Runner on Incus. Single entrypoint: instantiate (like vm:instantiate and tc:instantiate).

version: '3'

tasks:

  instantiate:
    silent: true
    desc: "Create a GitHub Actions runner VM. Usage: task runner:instantiate -- <remote-name> [<runner-name>] [--keep]"
    cmds:
      - task: instantiate:parse-args
      - task: instantiate:initialize-context
      - task: instantiate:verify-remote
      - task: instantiate:create-vm
      - task: instantiate:setup-runner-user
      - task: instantiate:install-github-runner
      - task: instantiate:cleanup-if-needed

  instantiate:parse-args:
    silent: true
    desc: "Parse CLI arguments for instantiate"
    cmds:
      - |
        set -euo pipefail
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/runner/scripts"
        source "${SCRIPT_DIR}/parse-args.sh" "{{.CLI_ARGS}}"

  instantiate:initialize-context:
    silent: true
    desc: "Initialize Windsor context and create windsor.yaml"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/runner/scripts"
        "${SCRIPT_DIR}/initialize-context.sh"

  instantiate:verify-remote:
    silent: true
    desc: "Verify Incus remote exists and is reachable"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/runner/scripts"
        "${SCRIPT_DIR}/verify-remote.sh"

  instantiate:create-vm:
    silent: true
    desc: "Create VM using vm:instantiate task"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/runner/scripts"
        "${SCRIPT_DIR}/create-vm.sh"

  instantiate:setup-runner-user:
    silent: true
    desc: "Setup runner user with same SSH keys as main user"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/runner/scripts"
        "${SCRIPT_DIR}/setup-runner-user.sh"

  instantiate:install-github-runner:
    silent: true
    desc: "Install and configure GitHub Actions runner (with interactive prompts if needed)"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/runner/scripts"
        "${SCRIPT_DIR}/install-github-runner.sh"

  instantiate:cleanup-if-needed:
    silent: true
    desc: "Cleanup VM if --keep flag was not set"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/runner/scripts"
        "${SCRIPT_DIR}/cleanup-if-needed.sh"

  status:
    silent: true
    desc: "Check status of GitHub Actions runner. Usage: task runner:status [-- <runner-name>]"
    cmds:
      - |
        set -euo pipefail
        
        RUNNER_NAME_ARG="{{.CLI_ARGS}}"
        RUNNER_NAME="${RUNNER_NAME_ARG:-runner}"
        
        # Export for script
        export RUNNER_NAME
        PROJECT_ROOT="${WINDSOR_PROJECT_ROOT:-$(pwd)}"
        ENV_FILE="${PROJECT_ROOT}/.runner-instantiate.env"
        {
          echo "export RUNNER_NAME='${RUNNER_NAME}'"
        } > "${ENV_FILE}"
        
        SCRIPT_DIR="${PROJECT_ROOT}/bin/runner/scripts"
        "${SCRIPT_DIR}/status-github-runner.sh"

  destroy:
    silent: true
    desc: "Destroy runner VM and remove it from GitHub repository. Usage: task runner:destroy [-- <runner-name>]"
    cmds:
      - |
        set -euo pipefail
        
        RUNNER_NAME_ARG="{{.CLI_ARGS}}"
        RUNNER_NAME="${RUNNER_NAME_ARG:-runner}"
        
        # Export for script
        export RUNNER_NAME
        PROJECT_ROOT="${WINDSOR_PROJECT_ROOT:-$(pwd)}"
        ENV_FILE="${PROJECT_ROOT}/.runner-instantiate.env"
        {
          echo "export RUNNER_NAME='${RUNNER_NAME}'"
        } > "${ENV_FILE}"
        
        SCRIPT_DIR="${PROJECT_ROOT}/bin/runner/scripts"
        "${SCRIPT_DIR}/destroy.sh" "${RUNNER_NAME}"

  help:
    silent: true
    desc: "Runner help"
    cmds:
      - |
        echo "GitHub Actions Runner (Incus)"
        echo ""
        echo "Create runner VM:"
        echo "    task runner:instantiate -- <remote-name> [<runner-name>] [--keep]"
        echo "      Creates a new runner VM, sets up the runner user, and installs GitHub Actions runner."
        echo "      Arguments:"
        echo "        <remote-name>          Required: Name of the Incus remote"
        echo "        <runner-name>          Optional: Name for the runner VM (default: 'runner')"
        echo "      Options:"
        echo "        --keep, --no-cleanup    Keep VM running (default: delete VM after setup)"
        echo ""
        echo "      Examples:"
        echo "        task runner:instantiate -- nuc"
        echo "        task runner:instantiate -- nuc my-runner"
        echo "        task runner:instantiate -- nuc my-runner --keep"
        echo ""
        echo "Check GitHub Actions runner status:"
        echo "    task runner:status [-- <runner-name>]"
        echo "      Reports the current status of the GitHub Actions runner service."
        echo "      Shows service status, runner name, and repository URL."
        echo "      If <runner-name> is not provided, defaults to 'runner'."
        echo ""
        echo "Destroy runner VM:"
        echo "    task runner:destroy [-- <runner-name>]"
        echo "      Destroys the runner VM and removes it from the GitHub repository."
        echo "      If <runner-name> is not provided, defaults to 'runner'."
        echo ""
