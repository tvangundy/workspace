# https://taskfile.dev

version: '3'

tasks:
  initialize:
    desc: Initializes a new Incus VM for GitHub Actions runner
    cmds:
      - task: install-aqua
      - task: install-docker
      - task: create-runner-user
      - task: setup-ssh
      - task: install-windsor-cli
      - |
        echo "Runner VM initialization complete!"
        echo "Next steps:"
        echo "  1. Install GitHub Actions runner: task runner:install-github-runner -- <vm-name>"
        echo "  2. Or follow the manual installation steps in the runbook"

  install-aqua:
    desc: Installs aqua package manager on the runner VM
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Error: VM name is required"
          echo "Usage: task runner:install-aqua -- <vm-name>"
          exit 1
        fi
        
        VM_NAME="{{.CLI_ARGS}}"
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        
        echo "Installing aqua on ${REMOTE}:${VM_NAME}..."
        
        # Install aqua using the official installer
        incus exec "${REMOTE}:${VM_NAME}" -- bash -c "
          set -euo pipefail
          
          # Check if aqua is already installed
          if command -v aqua >/dev/null 2>&1; then
            echo 'aqua is already installed'
            aqua version
            exit 0
          fi
          
          # Download and install aqua
          curl -fsSL https://raw.githubusercontent.com/aquaproj/aqua-installer/main/aqua-installer | bash
          
          # Add aqua to PATH for current session
          export PATH=\"\${HOME}/.local/share/aquaproj-aqua/bin:\${PATH}\"
          
          # Verify installation
          aqua version
          
          echo 'aqua installed successfully'
        "
        
        echo "aqua installation complete"

  install-docker:
    desc: Installs Docker on the runner VM
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Error: VM name is required"
          echo "Usage: task runner:install-docker -- <vm-name>"
          exit 1
        fi
        
        VM_NAME="{{.CLI_ARGS}}"
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        
        echo "Installing Docker on ${REMOTE}:${VM_NAME}..."
        
        incus exec "${REMOTE}:${VM_NAME}" -- bash -c "
          set -euo pipefail
          
          # Check if Docker is already installed
          if command -v docker >/dev/null 2>&1; then
            echo 'Docker is already installed'
            docker --version
            exit 0
          fi
          
          # Update package index
          apt-get update -y
          
          # Install prerequisites
          apt-get install -y \
            ca-certificates \
            curl \
            gnupg \
            lsb-release
          
          # Add Docker's official GPG key
          install -m 0755 -d /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
          chmod a+r /etc/apt/keyrings/docker.gpg
          
          # Set up Docker repository
          echo \\
            \"deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \\
            \$(. /etc/os-release && echo \"\$VERSION_CODENAME\") stable\" | \\
            tee /etc/apt/sources.list.d/docker.list > /dev/null
          
          # Install Docker Engine
          apt-get update -y
          apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
          
          # Start and enable Docker service
          systemctl start docker
          systemctl enable docker
          
          # Verify installation
          docker --version
          docker ps
          
          echo 'Docker installed successfully'
        "
        
        echo "Docker installation complete"

  create-runner-user:
    desc: Creates a dedicated runner user for GitHub Actions
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Error: VM name is required"
          echo "Usage: task runner:create-runner-user -- <vm-name>"
          exit 1
        fi
        
        VM_NAME="{{.CLI_ARGS}}"
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        RUNNER_USER="{{.RUNNER_USER}}"
        
        echo "Creating runner user '${RUNNER_USER}' on ${REMOTE}:${VM_NAME}..."
        
        incus exec "${REMOTE}:${VM_NAME}" -- bash -c "
          set -euo pipefail
          
          # Check if user already exists
          if id \"${RUNNER_USER}\" &>/dev/null; then
            echo \"User ${RUNNER_USER} already exists\"
            exit 0
          fi
          
          # Create runner user with home directory
          useradd -m -s /bin/bash \"${RUNNER_USER}\"
          
          # Add runner user to docker group (if Docker is installed)
          if getent group docker >/dev/null 2>&1; then
            usermod -aG docker \"${RUNNER_USER}\"
            echo \"Added ${RUNNER_USER} to docker group\"
          fi
          
          # Add runner user to sudo group (for administrative tasks)
          usermod -aG sudo \"${RUNNER_USER}\"
          
          # Set up sudoers to allow passwordless sudo (for automation)
          echo \"${RUNNER_USER} ALL=(ALL) NOPASSWD:ALL\" | tee /etc/sudoers.d/${RUNNER_USER}
          chmod 0440 /etc/sudoers.d/${RUNNER_USER}
          
          echo \"User ${RUNNER_USER} created successfully\"
        "
        
        echo "Runner user creation complete"

  setup-ssh:
    desc: Sets up SSH access for the runner user
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Error: VM name is required"
          echo "Usage: task runner:setup-ssh -- <vm-name>"
          exit 1
        fi
        
        VM_NAME="{{.CLI_ARGS}}"
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        RUNNER_USER="{{.RUNNER_USER}}"
        
        echo "Setting up SSH access for ${RUNNER_USER} on ${REMOTE}:${VM_NAME}..."
        
        incus exec "${REMOTE}:${VM_NAME}" -- bash -c "
          set -euo pipefail
          
          # Install OpenSSH server if not already installed
          if ! command -v sshd >/dev/null 2>&1; then
            apt-get update -y
            apt-get install -y openssh-server
          fi
          
          # Ensure SSH service is running
          systemctl start ssh || systemctl start sshd || true
          systemctl enable ssh || systemctl enable sshd || true
          
          # Create .ssh directory for runner user
          mkdir -p /home/${RUNNER_USER}/.ssh
          chmod 700 /home/${RUNNER_USER}/.ssh
          chown ${RUNNER_USER}:${RUNNER_USER} /home/${RUNNER_USER}/.ssh
          
          echo 'SSH setup complete'
          echo 'To add your SSH key, run:'
          echo '  incus exec ${REMOTE}:${VM_NAME} -- bash -c \"echo \\\"<your-public-key>\\\" >> /home/${RUNNER_USER}/.ssh/authorized_keys\"'
          echo '  incus exec ${REMOTE}:${VM_NAME} -- bash -c \"chmod 600 /home/${RUNNER_USER}/.ssh/authorized_keys\"'
          echo '  incus exec ${REMOTE}:${VM_NAME} -- bash -c \"chown ${RUNNER_USER}:${RUNNER_USER} /home/${RUNNER_USER}/.ssh/authorized_keys\"'
        "
        
        echo "SSH setup complete"

  install-github-runner:
    desc: Installs and configures GitHub Actions runner
    cmds:
      - |
        set -euo pipefail
        
        # Validate required environment variables
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Error: VM name is required"
          echo "Usage: task runner:install-github-runner -- <vm-name>"
          exit 1
        fi
        
        if [ -z "{{.GITHUB_RUNNER_REPO_URL}}" ]; then
          echo "Error: GITHUB_RUNNER_REPO_URL environment variable is not defined"
          echo "Set it in your windsor.yaml file (e.g., https://github.com/user/repo)"
          exit 1
        fi
        
        if [ -z "{{.GITHUB_RUNNER_TOKEN}}" ]; then
          echo "Error: GITHUB_RUNNER_TOKEN environment variable is not defined"
          echo "Set it in your windsor.yaml file (get the token from GitHub Settings → Actions → Runners)"
          exit 1
        fi
        
        VM_NAME="{{.CLI_ARGS}}"
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        RUNNER_USER="{{.RUNNER_USER}}"
        RUNNER_HOME="{{.RUNNER_HOME}}"
        REPO_URL="{{.GITHUB_RUNNER_REPO_URL}}"
        TOKEN="{{.GITHUB_RUNNER_TOKEN}}"
        RUNNER_VERSION="{{.GITHUB_RUNNER_VERSION | default ""}}"
        RUNNER_ARCH="{{.GITHUB_RUNNER_ARCH | default "x64"}}"
        
        # Get runner version if not specified
        if [ -z "${RUNNER_VERSION}" ]; then
          echo "Determining latest runner version..."
          RUNNER_VERSION=$(curl -s https://api.github.com/repos/actions/runner/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' | sed 's/v//')
          
          if [ -z "${RUNNER_VERSION}" ]; then
            echo "Error: Could not determine latest runner version"
            exit 1
          fi
        fi
        
        echo "Installing GitHub Actions runner on ${REMOTE}:${VM_NAME}..."
        echo "Repository: ${REPO_URL}"
        echo "Runner version: ${RUNNER_VERSION}"
        echo "Architecture: ${RUNNER_ARCH}"
        
        incus exec "${REMOTE}:${VM_NAME}" -- bash -c "
          set -euo pipefail
          
          # Create actions-runner directory as runner user
          sudo -u ${RUNNER_USER} mkdir -p ${RUNNER_HOME}/actions-runner
          cd ${RUNNER_HOME}/actions-runner
          
          # Download runner as runner user
          sudo -u ${RUNNER_USER} curl -o actions-runner-linux-${RUNNER_ARCH}-${RUNNER_VERSION}.tar.gz -L \\
            https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-${RUNNER_ARCH}-${RUNNER_VERSION}.tar.gz
          
          # Extract as runner user
          sudo -u ${RUNNER_USER} tar xzf ./actions-runner-linux-${RUNNER_ARCH}-*.tar.gz
          
          # Configure runner as runner user
          sudo -u ${RUNNER_USER} ./config.sh --url ${REPO_URL} --token ${TOKEN} --unattended
          
          # Install as systemd service (runs as runner user)
          sudo ./svc.sh install ${RUNNER_USER}
          sudo ./svc.sh start
          
          echo 'GitHub Actions runner installed and started'
        "
        
        echo "GitHub Actions runner installation complete"

  install-packages:
    desc: Installs additional packages commonly needed for GitHub Actions runners
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Error: VM name is required"
          echo "Usage: task runner:install-packages -- <vm-name>"
          exit 1
        fi
        
        VM_NAME="{{.CLI_ARGS}}"
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        
        echo "Installing additional packages on ${REMOTE}:${VM_NAME}..."
        
        incus exec "${REMOTE}:${VM_NAME}" -- bash -c "
          set -euo pipefail
          
          apt-get update -y
          apt-get install -y \\
            build-essential \\
            git \\
            curl \\
            wget \\
            python3 \\
            python3-pip \\
            nodejs \\
            npm \\
            default-jre \\
            default-jdk \\
            unzip \\
            software-properties-common \\
            jq \\
            yq \\
            rsync \\
            openssh-client
          
          echo 'Additional packages installed successfully'
        "
        
        echo "Package installation complete"

  install-windsor-cli:
    desc: Installs Windsor CLI on the runner VM
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Error: VM name is required"
          echo "Usage: task runner:install-windsor-cli -- <vm-name>"
          exit 1
        fi
        
        VM_NAME="{{.CLI_ARGS}}"
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        WINDSOR_VERSION="{{.WINDSOR_CLI_VERSION | default "v0.8.1"}}"
        
        echo "Installing Windsor CLI ${WINDSOR_VERSION} on ${REMOTE}:${VM_NAME}..."
        
        incus exec "${REMOTE}:${VM_NAME}" -- bash -c "
          set -euo pipefail
          
          # Check if Windsor CLI is already installed
          if command -v windsor >/dev/null 2>&1; then
            INSTALLED_VERSION=\$(windsor version 2>/dev/null | head -n1 || echo '')
            echo \"Windsor CLI already installed: \${INSTALLED_VERSION}\"
            exit 0
          fi
          
          # Detect platform and architecture
          PLATFORM=\$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=\$(uname -m)
          
          # Map architecture
          if [ \"\${ARCH}\" = \"x86_64\" ]; then
            ARCH=\"amd64\"
          elif [ \"\${ARCH}\" = \"arm64\" ] || [ \"\${ARCH}\" = \"aarch64\" ]; then
            ARCH=\"arm64\"
          fi
          
          # Install to /usr/local/bin for system-wide access
          INSTALL_DIR=\"/usr/local/bin\"
          
          # Download and install Windsor CLI directly (pipe curl to tar, no intermediate file)
          DOWNLOAD_URL=\"https://github.com/windsorcli/cli/releases/download/\${WINDSOR_VERSION}/windsor_\${WINDSOR_VERSION#v}_\${PLATFORM}_\${ARCH}.tar.gz\"
          echo \"Downloading and installing Windsor CLI from: \${DOWNLOAD_URL}\"
          
          curl -fsSL \"\${DOWNLOAD_URL}\" | sudo tar -xz -C \${INSTALL_DIR} windsor
          sudo chmod +x \${INSTALL_DIR}/windsor
          
          # Verify installation
          \${INSTALL_DIR}/windsor version
          echo \"Windsor CLI installed successfully to \${INSTALL_DIR}\"
        "
        
        echo "Windsor CLI installation complete"

  clean-work-dir:
    desc: Cleans the actions-runner/_work/test/test directory on the runner VM
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Error: VM name is required"
          echo "Usage: task runner:clean-work-dir -- <vm-name>"
          exit 1
        fi
        
        VM_NAME="{{.CLI_ARGS}}"
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        RUNNER_USER="{{.RUNNER_USER}}"
        RUNNER_HOME="{{.RUNNER_HOME}}"
        WORK_DIR="${RUNNER_HOME}/actions-runner/_work/test/test"
        
        echo "Cleaning work directory on ${REMOTE}:${VM_NAME}..."
        echo "Target directory: ${WORK_DIR}"
        
        incus exec "${REMOTE}:${VM_NAME}" -- bash -c "
          set -euo pipefail
          
          # Check if directory exists
          if [ ! -d \"${WORK_DIR}\" ]; then
            echo \"Directory ${WORK_DIR} does not exist, nothing to clean\"
            exit 0
          fi
          
          # Switch to runner user and remove all contents (preserves hidden files/dirs like .windsor)
          sudo -u ${RUNNER_USER} bash -c \"
            cd ${WORK_DIR}
            sudo rm -rf .windsor/.docker-cache
            sudo rm -rf .windsor
            sudo rm -rf .volumes
            rm -rf *
            echo 'Cleaned ${WORK_DIR} (hidden files/directories like .windsor are preserved)'
          \"
          
          echo 'Work directory cleaned successfully'
        "
        
        echo "Work directory cleanup complete"

  shell:
    desc: Opens an interactive shell session in the runner VM
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.CLI_ARGS}}" ]; then
          echo "Error: VM name is required"
          echo "Usage: task runner:shell -- <vm-name>"
          exit 1
        fi
        
        VM_NAME="{{.CLI_ARGS}}"
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        
        echo "Opening interactive shell on ${REMOTE}:${VM_NAME}..."
        echo "Type 'exit' to leave the shell"
        echo ""
        
        # Open interactive bash shell in the VM
        incus exec "${REMOTE}:${VM_NAME}" -- bash

  help:
    desc: Shows help for runner tasks
    cmds:
      - |
        echo "Runner Tasks"
        echo ""
        echo "Initialize a new runner VM:"
        echo "  task runner:initialize -- <vm-name>"
        echo ""
        echo "Individual setup tasks:"
        echo "  task runner:install-aqua -- <vm-name>"
        echo "  task runner:install-docker -- <vm-name>"
        echo "  task runner:create-runner-user -- <vm-name>"
        echo "  task runner:setup-ssh -- <vm-name>"
        echo "  task runner:install-windsor-cli -- <vm-name>"
        echo "  task runner:install-packages -- <vm-name>"
        echo ""
        echo "Install GitHub Actions runner:"
        echo "  task runner:install-github-runner -- <vm-name>"
        echo ""
        echo "Maintenance tasks:"
        echo "  task runner:clean-work-dir -- <vm-name>"
        echo ""
        echo "Example:"
        echo "  task runner:initialize -- github-runner-ubuntu"
        echo "  task runner:install-github-runner -- github-runner-ubuntu"
        echo "  task runner:clean-work-dir -- github-runner-ubuntu"
        echo "  task runner:shell -- github-runner-ubuntu"
        echo ""
        echo "Note: Requires GITHUB_RUNNER_REPO_URL and GITHUB_RUNNER_TOKEN environment variables"
