# https://taskfile.dev

version: '3'

tasks:

  generate-tfvars:
    silent: true
    desc: "Generate terraform.tfvars from environment variables"
    cmds:
      - |
        set -euo pipefail
        
        echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "Step: Generate terraform.tfvars"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        
        # Reload Windsor environment to get latest values (including VM_NETWORK_NAME set by initialize-context.sh)
        if command -v windsor > /dev/null 2>&1; then
          set +e  # Temporarily disable exit on error
          WINDSOR_ENV_OUTPUT=$(windsor env 2>/dev/null || echo "")
          set -e  # Re-enable exit on error
          if [ -n "${WINDSOR_ENV_OUTPUT}" ]; then
            eval "${WINDSOR_ENV_OUTPUT}" || true
          fi
        fi
        
        # Get environment variables with defaults
        INCUS_REMOTE_NAME="{{.INCUS_REMOTE_NAME}}"
        VM_NAME="{{.VM_INSTANCE_NAME}}"
        VM_NAME="${VM_NAME:-vm}"
        VM_IMAGE="{{.VM_IMAGE}}"
        VM_IMAGE="${VM_IMAGE:-ubuntu/24.04}"
        VM_MEMORY="{{.VM_MEMORY}}"
        VM_MEMORY="${VM_MEMORY:-8GB}"
        VM_CPU="{{.VM_CPU}}"
        VM_CPU="${VM_CPU:-4}"
        VM_AUTOSTART="{{.VM_AUTOSTART}}"
        VM_AUTOSTART="${VM_AUTOSTART:-false}"
        VM_DISK_SIZE="{{.VM_DISK_SIZE}}"
        # Get VM_NETWORK_NAME from environment (set by initialize-context.sh) or from Taskfile template
        PHYSICAL_NETWORK_NAME="${VM_NETWORK_NAME:-{{.VM_NETWORK_NAME}}}"
        STORAGE_POOL="{{.VM_STORAGE_POOL}}"
        STORAGE_POOL="${STORAGE_POOL:-local}"
        
        # Create terraform/vm directory if it doesn't exist
        TFVARS_DIR="terraform/vm"
        mkdir -p "${TFVARS_DIR}"
        TFVARS_FILE="${TFVARS_DIR}/terraform.tfvars"
        
        # Generate terraform.tfvars
        {
          printf "# Generated from environment variables - do not edit manually\n"
          printf "# Update environment variables in contexts/{{.WINDSOR_CONTEXT}}/windsor.yaml instead\n"
          printf "# To regenerate, run: task vm:generate-tfvars\n"
          printf "\n"
          printf "# Incus remote configuration\n"
          printf "incus_remote_name = \"${INCUS_REMOTE_NAME}\"\n"
          printf "\n"
          printf "# VM configuration\n"
          printf "vm_name = \"${VM_NAME}\"\n"
          printf "vm_image = \"${VM_IMAGE}\"\n"
          printf "vm_memory = \"${VM_MEMORY}\"\n"
          printf "vm_cpu = \"${VM_CPU}\"\n"
          printf "vm_autostart = ${VM_AUTOSTART}\n"
          if [ -n "${VM_DISK_SIZE}" ]; then
            printf "vm_disk_size = \"${VM_DISK_SIZE}\"\n"
          else
            printf "# vm_disk_size = \"\"  # Uses storage pool default if empty\n"
          fi
          printf "\n"
          printf "# Network configuration\n"
          if [ -n "${PHYSICAL_NETWORK_NAME}" ]; then
            printf "physical_network_name = \"${PHYSICAL_NETWORK_NAME}\"\n"
          else
            printf "# physical_network_name = \"\"  # Uses default Incus network if empty\n"
          fi
          printf "\n"
          printf "# Storage configuration\n"
          printf "storage_pool = \"${STORAGE_POOL}\"\n"
        } > "${TFVARS_FILE}"
        
        echo "✅ Generated ${TFVARS_FILE} from environment variables"
        echo ""
        echo "To regenerate, run: task vm:generate-tfvars"
        echo "To modify values, update environment variables in contexts/{{.WINDSOR_CONTEXT}}/windsor.yaml"

  terraform:init:
    silent: true
    desc: "Initialize Terraform for the VM"
    cmds:
      - |
        set -euo pipefail
        
        if [ -z "{{.WINDSOR_PROJECT_ROOT}}" ]; then
          echo "Error: WINDSOR_PROJECT_ROOT variable is not defined"
          echo "Run this from within a Windsor workspace"
          exit 1
        fi
        
        TERRAFORM_DIR="{{.WINDSOR_PROJECT_ROOT}}/terraform/vm"
        
        if [ ! -d "${TERRAFORM_DIR}" ]; then
          echo "Error: Terraform directory not found: ${TERRAFORM_DIR}"
          exit 1
        fi
        
        echo ""
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "Step: Initialize Terraform"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        cd "${TERRAFORM_DIR}"
        terraform init -upgrade

  terraform:plan:
    silent: true
    desc: "Show Terraform plan for the VM"
    cmds:
      - task: terraform:init
      - |
        set -euo pipefail
        
        TERRAFORM_DIR="{{.WINDSOR_PROJECT_ROOT}}/terraform/vm"
        cd "${TERRAFORM_DIR}"
        terraform plan

  terraform:apply:
    silent: true
    desc: "Apply Terraform configuration to create VM"
    cmds:
      - |
        set -euo pipefail
        
        TERRAFORM_DIR="{{.WINDSOR_PROJECT_ROOT}}/terraform/vm"
        cd "${TERRAFORM_DIR}"
        terraform apply -auto-approve

  terraform:destroy:
    silent: true
    desc: "Destroy the VM using Terraform"
    cmds:
      - |
        set -euo pipefail
        
        TERRAFORM_DIR="{{.WINDSOR_PROJECT_ROOT}}/terraform/vm"
        
        if [ ! -d "${TERRAFORM_DIR}" ]; then
          echo "Error: Terraform directory not found: ${TERRAFORM_DIR}"
          exit 1
        fi
        
        # Confirm deletion
        echo "⚠️  This will destroy the Ubuntu VM and all its data"
        echo "Press Ctrl+C to cancel, or wait 5 seconds to continue..."
        sleep 5
        
        cd "${TERRAFORM_DIR}"
        terraform destroy -auto-approve
        echo "✅ VM destroyed"

  destroy:
    silent: true
    desc: "Destroy the VM using Terraform. Optionally specify VM name: task vm:destroy [-- <vm-name>]"
    cmds:
      - |
        set -euo pipefail
        
        TERRAFORM_DIR="{{.WINDSOR_PROJECT_ROOT}}/terraform/vm"
        TFVARS_FILE="${TERRAFORM_DIR}/terraform.tfvars"
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        
        if [ -z "${REMOTE}" ]; then
          echo "Error: INCUS_REMOTE_NAME variable is not defined"
          exit 1
        fi
        
        if [ ! -d "${TERRAFORM_DIR}" ]; then
          echo "Error: Terraform directory not found: ${TERRAFORM_DIR}"
          exit 1
        fi
        
        # Parse instance name from CLI args or use default
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -n "${CLI_ARGS_STR}" ]; then
          eval set -- ${CLI_ARGS_STR}
          INSTANCE_NAME_ARG="${1}"
        else
          # Use default from environment variables
          if [ -n "{{.VM_INSTANCE_NAME}}" ]; then
            INSTANCE_NAME_ARG="{{.VM_INSTANCE_NAME}}"
          else
            INSTANCE_NAME_ARG="vm"
          fi
        fi
        
        echo "Destroying VM '${INSTANCE_NAME_ARG}'..."
        
        # Confirm deletion
        echo "⚠️  This will destroy the VM '${INSTANCE_NAME_ARG}' and all its data"
        echo "Press Ctrl+C to cancel, or wait 5 seconds to continue..."
        sleep 5
        
        # Check if VM exists in Incus
        VM_EXISTS=false
        if incus list "${REMOTE}:${INSTANCE_NAME_ARG}" --format csv -c n 2>/dev/null | grep -q "^${INSTANCE_NAME_ARG}$"; then
          VM_EXISTS=true
        fi
        
        # Try Terraform destroy first
        # Always use -var flag to override vm_name to ensure we destroy the correct VM
        TERRAFORM_SUCCESS=false
        cd "${TERRAFORM_DIR}"
        set +e  # Temporarily disable exit on error for Terraform
          terraform destroy -auto-approve -var "vm_name=${INSTANCE_NAME_ARG}" > /tmp/terraform_destroy.log 2>&1
        TERRAFORM_EXIT=$?
        set -e  # Re-enable exit on error
        
        # Check if Terraform actually destroyed something
        if [ ${TERRAFORM_EXIT} -eq 0 ]; then
          if grep -q "Resources: [1-9]" /tmp/terraform_destroy.log 2>/dev/null; then
            TERRAFORM_SUCCESS=true
            echo "✅ VM '${INSTANCE_NAME_ARG}' destroyed via Terraform"
          fi
        fi
        
        # If Terraform didn't destroy it (or VM wasn't in Terraform state), delete directly via Incus
        if [ "${TERRAFORM_SUCCESS}" = "false" ] && [ "${VM_EXISTS}" = "true" ]; then
          echo "⚠️  VM not found in Terraform state, deleting directly via Incus..."
          set +e  # Temporarily disable exit on error
          INCUS_DELETE_OUTPUT=$(incus delete "${REMOTE}:${INSTANCE_NAME_ARG}" --force 2>&1)
          INCUS_DELETE_EXIT=$?
          set -e  # Re-enable exit on error
          
          if [ ${INCUS_DELETE_EXIT} -eq 0 ]; then
            echo "✅ VM '${INSTANCE_NAME_ARG}' destroyed via Incus"
          else
            echo "❌ Failed to delete VM '${INSTANCE_NAME_ARG}'"
            if [ -n "${INCUS_DELETE_OUTPUT}" ]; then
              echo "   Error: ${INCUS_DELETE_OUTPUT}"
            fi
            # Try to get VM status for debugging
            echo "   VM status:"
            incus list "${REMOTE}:${INSTANCE_NAME_ARG}" 2>&1 | head -3 || true
            exit 1
          fi
        elif [ "${TERRAFORM_SUCCESS}" = "false" ] && [ "${VM_EXISTS}" = "false" ]; then
          echo "⚠️  VM '${INSTANCE_NAME_ARG}' not found in Terraform state or Incus"
          echo "   (It may have already been deleted)"
        fi

  delete:
    silent: true
    desc: "Delete the VM directly using Incus (bypasses Terraform). Optionally specify VM name: task vm:delete [-- <vm-name>]"
    cmds:
      - |
        set -euo pipefail
        
        REMOTE="{{.INCUS_REMOTE_NAME}}"
        
        if [ -z "${REMOTE}" ]; then
          echo "Error: INCUS_REMOTE_NAME variable is not defined"
          exit 1
        fi
        
        # Parse instance name from CLI args or use default
        CLI_ARGS_STR="{{.CLI_ARGS}}"
        if [ -n "${CLI_ARGS_STR}" ]; then
          eval set -- ${CLI_ARGS_STR}
          INSTANCE_NAME_ARG="${1}"
        else
          # Use default from environment variables
          if [ -n "{{.VM_INSTANCE_NAME}}" ]; then
            INSTANCE_NAME_ARG="{{.VM_INSTANCE_NAME}}"
          else
            INSTANCE_NAME_ARG="vm"
          fi
        fi
        
        echo "Deleting VM '${INSTANCE_NAME_ARG}' directly via Incus..."
        
        # Check if VM exists in Incus
        VM_EXISTS=false
        if incus list "${REMOTE}:${INSTANCE_NAME_ARG}" --format csv -c n 2>/dev/null | grep -q "^${INSTANCE_NAME_ARG}$"; then
          VM_EXISTS=true
        fi
        
        if [ "${VM_EXISTS}" = "false" ]; then
          echo "⚠️  VM '${INSTANCE_NAME_ARG}' not found on remote '${REMOTE}'"
          echo "   (It may have already been deleted)"
          exit 0
        fi
        
        # Show VM status before deletion
        echo ""
        echo "VM details:"
        incus list "${REMOTE}:${INSTANCE_NAME_ARG}" || true
        echo ""
        
        # Confirm deletion
        echo "⚠️  This will permanently delete the VM '${INSTANCE_NAME_ARG}' and all its data"
        echo "   This action cannot be undone and will NOT update Terraform state"
        echo "   Press Ctrl+C to cancel, or wait 5 seconds to continue..."
        sleep 5
        
        # Delete via Incus
        set +e  # Temporarily disable exit on error
        INCUS_DELETE_OUTPUT=$(incus delete "${REMOTE}:${INSTANCE_NAME_ARG}" --force 2>&1)
        INCUS_DELETE_EXIT=$?
        set -e  # Re-enable exit on error
        
        if [ ${INCUS_DELETE_EXIT} -eq 0 ]; then
          echo "✅ VM '${INSTANCE_NAME_ARG}' deleted successfully via Incus"
        else
          echo "❌ Failed to delete VM '${INSTANCE_NAME_ARG}'"
          if [ -n "${INCUS_DELETE_OUTPUT}" ]; then
            echo "   Error: ${INCUS_DELETE_OUTPUT}"
          fi
          # Try to get VM status for debugging
          echo "   Current VM status:"
          incus list "${REMOTE}:${INSTANCE_NAME_ARG}" 2>&1 | head -3 || true
          exit 1
        fi

  list:
    silent: true
    desc: "List all Ubuntu VMs"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/list.sh"

  instantiate:
    silent: true
    desc: "Primary way to create a new Ubuntu VM. Sets up the complete VM environment including Incus client, developer tools, and optionally workspace initialization. Usage: task vm:instantiate -- <remote-name> [<vm-name>] [--keep] [--no-workspace] [--windsor-up]"
    cmds:
      - task: instantiate:parse-args
      - task: instantiate:initialize-context
      - task: instantiate:verify-remote
      - task: instantiate:check-vm-image
      - task: instantiate:create-vm
      - task: instantiate:setup-ssh
      - task: instantiate:setup-incus
      - task: instantiate:install-tools
      - task: instantiate:init-workspace
      - task: instantiate:validate-vm
      - task: instantiate:cleanup-if-needed

  instantiate:parse-args:
    silent: true
    desc: "Parse CLI arguments for instantiate task"
    cmds:
      - |
        set -euo pipefail
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        # Source the script to export variables to this shell
        source "${SCRIPT_DIR}/parse-args.sh" "{{.CLI_ARGS}}"

  instantiate:install-tools:
    silent: true
    desc: "Install tools jq, Homebrew, aqua, docker, and windsor"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/install-tools.sh"

  instantiate:initialize-context:
    silent: true
    desc: "Initialize Windsor context for instantiate"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/initialize-context.sh"

  instantiate:verify-remote:
    silent: true
    desc: "Verify remote connection exists"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/verify-remote.sh"

  instantiate:check-vm-image:
    silent: true
    desc: "Ensure VM image is available on remote"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/check-vm-image.sh"

  instantiate:create-vm:
    silent: true
    desc: "Create VM using Terraform and setup developer environment"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/create-vm.sh"

  instantiate:setup-incus:
    silent: true
    desc: "Setup Incus client on the VM and configure remote connection"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/setup-incus.sh"

  instantiate:validate-vm:
    silent: true
    desc: "Validate VM setup and functionality"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/validate-vm.sh"

  instantiate:setup-ssh:
    silent: true
    desc: "Setup SSH access for the user on the VM"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/setup-ssh.sh"

  instantiate:init-workspace:
    silent: true
    desc: "Initialize workspace on the VM if VM_INIT_WORKSPACE is true"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/init-workspace.sh"

  instantiate:cleanup-if-needed:
    silent: true
    desc: "Cleanup VM if --keep flag was not set"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/cleanup-if-needed.sh"

  runner:setup-incus:
    silent: true
    desc: "Sets up Incus client on the VM and configures the nuc remote with trust token"
    cmds:
      - |
        SCRIPT_DIR="${WINDSOR_PROJECT_ROOT:-$(pwd)}/bin/vm/scripts"
        "${SCRIPT_DIR}/setup-incus-runner.sh" "{{.CLI_ARGS}}"

  help:
    silent: true
    desc: "Ubuntu VM commands"
    cmds:
      - |
        echo "Ubuntu Virtual Machine (Incus)"
        echo ""
        echo "Create VM:"
        echo "    task vm:instantiate -- <remote-name> [<vm-name>] [--keep] [--no-workspace] [--windsor-up]"
        echo "      Primary way to create and setup a new VM (includes Incus client setup)"
        echo "      Arguments:"
        echo "        <remote-name>          Required: Name of the Incus remote"
        echo "        <vm-name>              Optional: Name for the VM (default: 'vm')"
        echo "      Options:"
        echo "        --keep, --no-cleanup    Keep VM running (default: delete VM)"
        echo "        --no-workspace          Skip workspace initialization (default: initialize workspace)"
        echo "        --windsor-up            Run windsor init and windsor up after workspace setup"
        echo "      Examples:"
        echo "        task vm:instantiate -- nuc"
        echo "        task vm:instantiate -- nuc my-vm"
        echo "        task vm:instantiate -- nuc my-vm --keep"
        echo ""
        echo "List VMs:"
        echo "    task vm:list"
        echo "      Lists all Ubuntu VMs on the configured remote."
        echo ""
        echo "Delete VM (direct Incus):"
        echo "    task vm:delete [-- <vm-name>]"
        echo "      Deletes the VM directly via Incus (bypasses Terraform)."
        echo "      If <vm-name> is not provided, uses the current context."
        echo ""
        echo "Destroy VM (Terraform):"
        echo "    task vm:destroy [-- <vm-name>]"
        echo "      Destroys the VM using Terraform (updates Terraform state)."
        echo "      Falls back to Incus delete if VM is not in Terraform state."
        echo "      If <vm-name> is not provided, uses the current context."
        echo ""

