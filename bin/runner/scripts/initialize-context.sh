#!/usr/bin/env bash
# Initialize Windsor context for runner instantiate
set -euo pipefail

# Load environment variables from file if it exists
PROJECT_ROOT="${WINDSOR_PROJECT_ROOT:-$(pwd)}"
ENV_FILE="${PROJECT_ROOT}/.runner-instantiate.env"
if [ -f "${ENV_FILE}" ]; then
  source "${ENV_FILE}"
fi

TEST_REMOTE_NAME="${TEST_REMOTE_NAME:-${INCUS_REMOTE_NAME}}"
RUNNER_NAME="${RUNNER_NAME:-runner}"
PROJECT_ROOT="${PROJECT_ROOT:-${WINDSOR_PROJECT_ROOT}}"
PROJECT_ROOT="${PROJECT_ROOT:-$(pwd)}"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Step: Initialize Windsor Context"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Create contexts directory if it doesn't exist
CONTEXTS_DIR="${PROJECT_ROOT}/contexts"

# Determine which context directory to use
# If there's an active context, use that directory; otherwise use RUNNER_NAME
ACTIVE_CONTEXT=""
if command -v windsor > /dev/null 2>&1; then
  ACTIVE_CONTEXT=$(windsor context get 2>/dev/null || echo "")
  if [ -z "${ACTIVE_CONTEXT}" ] && [ -n "${WINDSOR_CONTEXT:-}" ]; then
    ACTIVE_CONTEXT="${WINDSOR_CONTEXT}"
  fi
fi

if [ -n "${ACTIVE_CONTEXT}" ]; then
  # Use active context directory
  TEST_CONTEXT_DIR="${CONTEXTS_DIR}/${ACTIVE_CONTEXT}"
else
  # No active context, use RUNNER_NAME
  TEST_CONTEXT_DIR="${CONTEXTS_DIR}/${RUNNER_NAME}"
fi

TEST_WINDSOR_YAML="${TEST_CONTEXT_DIR}/windsor.yaml"
mkdir -p "${TEST_CONTEXT_DIR}"

# Check if windsor.yaml already exists
if [ -f "${TEST_WINDSOR_YAML}" ]; then
  echo "  Found existing windsor.yaml, updating environment variables..."
else
  echo "  Creating new windsor.yaml..."
  # Get default values for VM configuration (runner VMs should autostart)
  VM_AUTOSTART="${VM_AUTOSTART:-true}"  # Runner VMs should start automatically on host reboot
  VM_INIT_WORKSPACE="${VM_INIT_WORKSPACE:-false}"  # Runner VMs don't need workspace initialization
  
  # Create basic windsor.yaml structure
  cat > "${TEST_WINDSOR_YAML}" <<EOF
# Windsor configuration for runner: ${RUNNER_NAME}
# Generated by runner:instantiate task

environment:
  INCUS_REMOTE_NAME: "${TEST_REMOTE_NAME}"
  RUNNER_NAME: "${RUNNER_NAME}"
  RUNNER_USER: "runner"
  RUNNER_HOME: "/home/runner"
  VM_AUTOSTART: ${VM_AUTOSTART}
  VM_INIT_WORKSPACE: ${VM_INIT_WORKSPACE}
EOF
fi

# Get default values for VM configuration (runner VMs should autostart)
VM_AUTOSTART="${VM_AUTOSTART:-true}"  # Runner VMs should start automatically on host reboot
VM_INIT_WORKSPACE="${VM_INIT_WORKSPACE:-false}"  # Runner VMs don't need workspace initialization

# Update environment variables in windsor.yaml
# Use awk to intelligently update the environment section
RUNNER_VARS=(
  "INCUS_REMOTE_NAME"
  "RUNNER_NAME"
  "RUNNER_USER"
  "RUNNER_HOME"
  "GITHUB_RUNNER_REPO_URL"
  "GITHUB_RUNNER_TOKEN"
  "GITHUB_RUNNER_VERSION"
  "GITHUB_RUNNER_ARCH"
  "VM_AUTOSTART"
  "VM_INIT_WORKSPACE"
)

# Create temp file with new values
# Secrets should always use SOPS syntax, not actual values
TEMP_ENV=$(mktemp)
for var in "${RUNNER_VARS[@]}"; do
  # For secrets, always use SOPS syntax
  if [[ "${var}" == "GITHUB_RUNNER_REPO_URL" ]] || [[ "${var}" == "GITHUB_RUNNER_TOKEN" ]]; then
    echo "${var}: \"\${{ sops.${var} }}\"" >> "${TEMP_ENV}"
  # For boolean values, always include them (even if empty, use default)
  elif [[ "${var}" == "VM_AUTOSTART" ]] || [[ "${var}" == "VM_INIT_WORKSPACE" ]]; then
    eval "value=\${${var}:-}"
    if [ -z "${value}" ]; then
      # Use the default we set above
      eval "value=\${${var}}"
    fi
    echo "${var}: ${value}" >> "${TEMP_ENV}"
  else
    eval "value=\${${var}:-}"
    if [ -n "${value}" ]; then
      echo "${var}: \"${value}\"" >> "${TEMP_ENV}"
    fi
  fi
done

# Use awk to update windsor.yaml
awk -v temp_env="${TEMP_ENV}" '
BEGIN {
  in_environment = 0
  # Read new values
  while (getline line < temp_env > 0) {
    split(line, parts, ":")
    var_name = parts[1]
    gsub(/^[ \t]+|[ \t]+$/, "", var_name)
    new_values[var_name] = line
  }
  close(temp_env)
}
/^environment:/ {
  in_environment = 1
  print
  next
}
/^[a-zA-Z_][a-zA-Z0-9_]*:/ && in_environment {
  # End of environment section
  in_environment = 0
  # Print new values
  for (var in new_values) {
    print "  " new_values[var]
  }
  print
  next
}
in_environment {
  # Inside environment section
  # Check if this line matches any variable we want to replace
  matched = 0
  for (var in new_values) {
    if ($0 ~ "^[ \t]+" var ":") {
      matched = 1
      break
    }
  }
  if (!matched) {
    print
  }
  next
}
!in_environment {
  print
}
END {
  if (in_environment) {
    # Still in environment section at end of file
    for (var in new_values) {
      print "  " new_values[var]
    }
  }
}
' "${TEST_WINDSOR_YAML}" > "${TEST_WINDSOR_YAML}.tmp" && mv "${TEST_WINDSOR_YAML}.tmp" "${TEST_WINDSOR_YAML}"

rm -f "${TEMP_ENV}"

# Initialize or set Windsor context
if [ -n "${ACTIVE_CONTEXT}" ]; then
  # Active context exists, just ensure it's set
  if command -v windsor > /dev/null 2>&1; then
    windsor context set "${ACTIVE_CONTEXT}" 2>/dev/null || true
  fi
  echo "  Using existing Windsor context: ${ACTIVE_CONTEXT}"
else
  # No active context, initialize new one
  if command -v windsor > /dev/null 2>&1; then
    if ! windsor context list 2>/dev/null | grep -q "^${RUNNER_NAME}$"; then
      echo "  Initializing new Windsor context: ${RUNNER_NAME}"
      cd "${PROJECT_ROOT}"
      windsor init --context "${RUNNER_NAME}" 2>/dev/null || true
    fi
    windsor context set "${RUNNER_NAME}" 2>/dev/null || true
  fi
  echo "  Created/updated Windsor context: ${RUNNER_NAME}"
fi

# Export WINDSOR_CONTEXT for subsequent scripts
if [ -n "${ACTIVE_CONTEXT}" ]; then
  export WINDSOR_CONTEXT="${ACTIVE_CONTEXT}"
else
  export WINDSOR_CONTEXT="${RUNNER_NAME}"
fi

# Update env file
{
  echo "export WINDSOR_CONTEXT='${WINDSOR_CONTEXT}'"
} >> "${ENV_FILE}"

echo "✅ Windsor context initialized: ${WINDSOR_CONTEXT}"
echo "   Configuration: ${TEST_WINDSOR_YAML}"

